---
title: "Bimodality Paper Draft"
author: "Kelly Heilman"
date: "March 7th, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Figures:

### Figure 1: multipanel figure 
```{r, echo = FALSE,warning = FALSE}
library(gridExtra)
library(grid)
library(ggplot2)
library(maps)
library(sp)
library(plyr)


all_states <- map_data("state")
states <- subset(all_states, region %in% c(  'minnesota','wisconsin','michigan',"illinois",  'indiana') )
coordinates(states)<-~long+lat
class(states)
proj4string(states) <-CRS("+proj=longlat +datum=NAD83")
mapdata<-spTransform(states, CRS('+init=epsg:3175'))
mapdata <- data.frame(mapdata)



dens.pr <- read.csv("data/PLS_full_dens_pr_with_bins.csv")

# fia and pls plots
sc <- scale_colour_gradientn(colours = rev(terrain.colors(8)), limits=c(0, 16))
cbpalette <- c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837")
cbPalette <- c("#999999","#009E73", "#E69F00", "#56B4E9",  "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


pls.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=dens.pr, aes(x=x, y=y, fill = PLSdensity))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing")+ #+ 
  scale_fill_gradientn(colours = cbpalette, limits = c(0,600), name ="Tree \n Density \n (trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())


png("/Users/kah/Documents/bimodality/outputs/paper_figs/PLS_density_map.png")
pls.map
dev.off()

# read in the composition data for PLS and FIA (PC1 and PC2):
full.comps<- read.csv("outputs/cluster/fullcomps_dataset.csv")

pls.comp.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "PLS",], aes(x=x, y=y, fill = pc2))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(-10.5,3), name ="Species \n composition \n PC2", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())

# make a map of Oak composition:
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/Oak_map_pls.png")
pls.Oak.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "PLS",], aes(x=x, y=y, fill = Oak))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Oak Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())
pls.Oak.map
dev.off()

# make a map of Maple composition:
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/Maple_map_pls.png")
pls.Maple.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "PLS",], aes(x=x, y=y, fill = Maple))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Maple Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())
pls.Maple.map
dev.off()

# make a map of Hemlock composition:
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/hemlock_map_pls.png")
pls.Hemlock.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "PLS",], aes(x=x, y=y, fill = Hemlock))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Hemlock Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())
pls.Hemlock.map
dev.off()

# make a map of Beech composition:
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/Beech_map_pls.png")
pls.Beech.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "PLS",], aes(x=x, y=y, fill = Beech))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Beech Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())
pls.Beech.map
dev.off()

png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/Pine_map_pls.png")

pls.Pine.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "PLS",], aes(x=x, y=y, fill = Pine))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Oak Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())
pls.Pine.map
dev.off()
# --------------------What is the relationship between tree density and Oak % composition?------------------------------------------------------------------
comp.dens<- merge(full.comps[full.comps$period %in% "PLS",], dens.pr[,c("x","y", "cell", "PLSdensity")], by = c("x", "y", "cell"))

# plot the density (x-axis) vs. species composition (y-axis), with marginal histograms

library(ggExtra)
# Oak vs. dens
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/supp_oak_v_dens.png")
Oakvdens <- ggplot(comp.dens, aes(PLSdensity, Oak))+geom_point(size = 0.5)
O <- ggExtra::ggMarginal(Oakvdens, type = "histogram",size = 3, colour = 'black', fill = 'blue')
O
dev.off()


# beech vs. dens
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/supp_beech_v_dens.png")
Beechvdens <- ggplot(comp.dens, aes(PLSdensity, Beech))+geom_point(size = 0.5)
B <- ggExtra::ggMarginal(Beechvdens, type = "histogram",size = 3, colour = 'black', fill = 'blue')
B
dev.off()

# maple vs. dens
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/supp_maple_v_dens.png")
Maplevdens <- ggplot(comp.dens, aes(PLSdensity, Maple))+geom_point(size = 0.5)
C <- ggExtra::ggMarginal(Maplevdens, type = "histogram",size = 3, colour = 'black', fill = 'blue')
C
dev.off()

#hemlocak vs. dens
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/supp_hemlock_v_dens.png")
Hemlockvdens<- ggplot(comp.dens, aes(PLSdensity, Hemlock))+geom_point(size = 0.5)
H <- ggExtra::ggMarginal(Hemlockvdens, type = "histogram",size = 3, colour = 'black', fill = 'blue')
H
dev.off()

# pine vs. dens
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/supp_pine_v_dens.png")
Pinevdens <- ggplot(comp.dens, aes(PLSdensity, Pine))+geom_point(size = 0.5)
P <- ggExtra::ggMarginal(Pinevdens, type = "histogram",size = 3, colour = 'black', fill = 'blue')
P
dev.off()

comp.dens$PC1_bins_f2 <- factor(comp.dens$PC1bins, levels = c("5 - 6", "4 - 5", "3 - 4",
                                                       "2 - 3", "1 - 2", "0 - 1", "-1 - 0",
                                                       "-2 - -1", "-3 - -2", "-4 - -3",
                                                       "-5 - -4"))

# for the places where density is bimodal:
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/supp_oak_v_bimodal_dens.png")
Oakvbimodens <- ggplot(comp.dens, aes(PLSdensity, Oak))+geom_point(size = 0.5)+facet_wrap(~PC1_bins_f2, ncol = 4)
#Ob <- ggExtra::ggMarginal(Oakvbimodens, type = "histogram",size = 3, colour = 'black', fill = 'blue')
Oakvbimodens
dev.off()



# ---------------plot out the environmental PC:


# using "scale dens" from PLS_full_density_processing.R
dens.pr <- read.csv("data/PLS_full_dens_pr_with_bins.csv")
dens.rm <- na.exclude(dens.pr)
dens.rm <- data.frame(dens.rm)
# using newggbiplot

source("R/newggbiplot.R")
scale.dens <- scale(dens.rm[, c('MAP1910', "MAP2011", "moderndeltaP", 
                                "pastdeltaP", "modtmean", "pasttmean",
                                "moddeltaT", "deltaT", "sandpct", "awc")]) #PC all but ksat and diff

pretty.scale <- scale.dens[,c('MAP1910',   
                              "pastdeltaP", "pasttmean",
                              "deltaT", "sandpct", "awc")]
colnames(pretty.scale) <- c("MAP", "PSI", "MAT", "TSI", "sand", "awc")

pretty.pca <- princomp(pretty.scale,
                     na.rm=TRUE) 

g <- newggbiplot(pretty.pca, obs.scale = 1, var.scale = 1, labels.size
              = 25,alpha = 0,color = "blue",  alpha_arrow = 1, line.size = 1.5)


scores <- data.frame(pretty.pca$scores[,1:2])
scores$PLS <- dens.rm$PLSdensity

dens.rm$PC1 <- scores[,1]
dens.rm$PC2 <- scores[,2]
dens.rm <- data.frame(dens.rm)

dens.rm[sample(1:nrow(dens.rm)),]

PC <- dens.pca


# layer the points from pls underneath the pca biplot
# using a clever trick to manipulate the layers
g$layers <- c(geom_point(data = dens.rm, aes(x = PC1, y = PC2, color = PLSdensity), size = 0.5), g$layers)
g <- g + scale_color_gradientn(colours = cbpalette, limits = c(0,600), name ="Tree \n Density \n (trees/hectare)", na.value = 'darkgrey') +theme_bw(base_size = 10) 

#write to png
png(width = 8, height = 4,unit="in", res=300, paste0("outputs/paper_figs/pca_biplot.png"))
g 
dev.off()


oak.hist<- ggplot(full.comps, aes(Oak, fill = period))+geom_density(stat = 'identity')

# --------------plot out the species Principal component:


fullcomps <- read.csv("outputs/cluster/fullcomps.csv")
fc <- fullcomps
fullcomps <- fullcomps[!names(fullcomps) %in% c("No.tree", "Other.softwood", "period", "FIAdensity")]


# pca on the scaled data
full.pca <- princomp(scale(fullcomps[,6:ncol(fullcomps)])) #scale to 0 variance
plot(full.pca)

biplot(full.pca)
scores <- full.pca$scores

fc$pc1 <- scores[,1]
fc$pc2 <- scores[,2]

# merge fc dataset with the dens.rm dataset that has environmental PCA datasets:
fc.dens <- merge(fc[fc$period %in% "Past",], dens.rm, by = c("x","y", "cell"))

#library(ggbiplot)
source("R/newggbiplot.R")

fc.dens[sample(1:nrow(fc.dens)),]

gcomp <- newggbiplot(pretty.pca, obs.scale = 1, var.scale = 1, labels.size
                 = 25,alpha = 0,color = "blue",  alpha_arrow = 1, line.size = 1.5, scale = TRUE)
gcomp$layers <- c(geom_point(data = fc.dens, aes(x = PC1, y = PC2, color = pc2), size = 0.5), gcomp$layers)
# color points by species composition PC:
gcomp <- gcomp+ scale_color_gradientn(colours = rev(rainbow(3)), limits = c(-10.5,3), name ="Species \n composition \n PC2", na.value = 'darkgrey')

png("outputs/paper_figs/full_composition_PCA_biplot.png")
gcomp + theme_bw(base_size = 10)
dev.off()

# make this same figure, but with oak composition:
ocomp <- newggbiplot(pretty.pca, obs.scale = 1, var.scale = 1, labels.size
                 = 25,alpha = 0,color = "black",  alpha_arrow = 1, line.size = 1.5, scale = TRUE)
ocomp$layers <- c(geom_point(data = fc.dens, aes(x = PC1, y = PC2, color = Oak), size = 0.5), ocomp$layers)
# color points by species composition PC:
ocomp <- ocomp+ scale_color_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Oak Composition", na.value = 'darkgrey')

png("outputs/paper_figs/Oak_composition_PCA_biplot.png")
ocomp + theme_bw(base_size = 10)
dev.off()

#make pca plot with Maple composition:
mcomp <- newggbiplot(pretty.pca, obs.scale = 1, var.scale = 1, labels.size
                 = 25,alpha = 0,color = "black",  alpha_arrow = 1, line.size = 1.5, scale = TRUE)
mcomp$layers <- c(geom_point(data = fc.dens, aes(x = PC1, y = PC2, color = Maple), size = 0.5), mcomp$layers)
# color points by species composition PC:
mcomp <- mcomp+ scale_color_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Maple Composition", na.value = 'darkgrey')

png("outputs/paper_figs/Maple_composition_PCA_biplot.png")
mcomp + theme_bw(base_size = 10)
dev.off()

# make pca with Beech composition
bcomp <- newggbiplot(pretty.pca, obs.scale = 1, var.scale = 1, labels.size
                 = 25,alpha = 0,color = "black",  alpha_arrow = 1, line.size = 1.5, scale = TRUE)
bcomp$layers <- c(geom_point(data = fc.dens, aes(x = PC1, y = PC2, color = Beech), size = 0.5), bcomp$layers)
# color points by species composition PC:
bcomp <- bcomp+ scale_color_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Beech Composition", na.value = 'darkgrey')

png("outputs/paper_figs/Beech_composition_PCA_biplot.png")
bcomp + theme_bw(base_size = 10)
dev.off()

# make with Hemlock compsition:
hcomp <- newggbiplot(pretty.pca, obs.scale = 1, var.scale = 1, labels.size
                 = 25,alpha = 0,color = "black",  alpha_arrow = 1, line.size = 1.5, scale = TRUE)
hcomp$layers <- c(geom_point(data = fc.dens, aes(x = PC1, y = PC2, color = Hemlock), size = 0.5), hcomp$layers)
# color points by species composition PC:
hcomp <- ocomp+ scale_color_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Hemlock Composition", na.value = 'darkgrey')

png("outputs/paper_figs/Hemlock_composition_PCA_biplot.png")
hcomp + theme_bw(base_size = 10)
dev.off()

# make with Pine compsition:
pcomp <- newggbiplot(pretty.pca, obs.scale = 1, var.scale = 1, labels.size
                 = 25,alpha = 0,color = "black",  alpha_arrow = 1, line.size = 1.5, scale = TRUE)
pcomp$layers <- c(geom_point(data = fc.dens, aes(x = PC1, y = PC2, color = Pine), size = 0.5), hcomp$layers)
# color points by species composition PC:
pcomp <- pcomp+ scale_color_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Pine Composition", na.value = 'darkgrey')

png("outputs/paper_figs/Pine_composition_PCA_biplot.png")
hcomp + theme_bw(base_size = 10)
dev.off()


# --------------plot out density vs. envt, pc2 vs envt, and individual species compositions vs. the envt---------------------------------------------------

# hexbin plot for PLS density:
new.dens <- merge(dens, full.comps[full.comps$period %in% "PLS", c("x", "y", "cell", "PC1")], by = c("x", "y", "cell"))

png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/dens_PC1_hex.png")

pls.dens.hex<- ggplot(new.dens, aes( PC1, PLSdensity)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab(" PLS Tree Density /n (stems/ha)")
pls.dens.hex
dev.off()

# hexbin plot for pls composition:
png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/comppc2_PC1_hex.png")

pls.comp.hex <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(PC1, pc2)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Species Composition PC2")
pls.comp.hex
dev.off()

# hexbin for pls oak comp:

pls.oak.hex <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(PC1, Oak)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Oak Composition")


png(height = 6, width = 6, units ="in",res=200,"outputs/oak_PC1_hexbin.png")
pls.oak.hex
dev.off()

# hexbin for pls maple composition
pls.maple.hex <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(PC1, Maple)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Maple composition")

png(height = 6, width = 6, units ="in",res=200,"outputs/maple_PC1_hexbin.png")
pls.maple.hex
dev.off()

# hexbin for pls hemlock compsition:
pls.hemlock.hex <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(PC1, Hemlock)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Hemlock Composition")

png(height = 6, width = 6, units ="in",res=200,"outputs/hemlock_PC1_hexbin.png")
pls.hemlock.hex
dev.off()

# hexbin for pls beech composition:
pls.beech.hex <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(PC1, Beech)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Beech Composition")

png(height = 6, width = 6, units ="in",res=200,"outputs/beech_PC1_hexbin.png")
pls.beech.hex
dev.off()

# hexbin for pls pine composition:
pls.pine.hex <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(PC1, Pine)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Pine Composition")

png(height = 6, width = 6, units ="in",res=200,"outputs/pine_PC1_hexbin.png")
pls.pine.hex
dev.off()

FIA.comps <- full.comps[full.comps$period %in% "FIA",]
PLS.comps <- full.comps[full.comps$period %in% "PLS",]

Oaks <- merge(FIA.comps[,c("x","y","cell", "Oak")],PLS.comps[,c("x","y","cell", "Oak")], by = c("x","y","cell"))

colnames(Oaks) <- c("x","y","cell", "FIAoak", "PLSoak")
Oaks.d <- merge(Oaks, dens.pr[c("x","y","cell", "PLSdensity")])
Oaks.d$diff <- Oaks.d$PLSoak - Oaks.d$FIAoak


diffplot <- ggplot(Oaks.d[Oaks.d$PLSdensity > 0,], aes(PLSdensity, diff))+geom_point(size = 0.5)+ylab("PLS - FIA Oak composition")

diffmap <- ggplot(Oaks.d, aes(x,y, fill=diff))+geom_raster()+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") +
  coord_equal()+theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())


oakpls <- ggplot(Oaks.d, aes(PLSdensity, PLSoak, color = diff))+geom_point(size = 0.5) + ylab("PLS - FIA Oak composition")

oakpls <- ggplot(Oaks.d, aes(PLSoak, diff, color = diff))+geom_point(size = 0.5)+ylab("PLS - FIA Oak composition")



# --------------------Plot each species composition against envt-------------
# what I should do is loop through each composition, and make map, histogram, histogram over climate space, etx

# community compositiosn
# 1. Hemlock, Birch, Maple
full.comps$Hemlock.Birch.Maple <- rowSums(full.comps[,c("Hemlock", "Birch", "Maple")])

# 2. Beech, Hemlock, Mapme (BHM)
full.comps$Hemlock.Beech.Maple <- rowSums(full.comps[,c("Hemlock", "Beech", "Maple")])


# 3. Cedar, Hemlock, Pine (CHP)
full.comps$Cedar.Hemlock.Pine <- rowSums(full.comps[,c("Hemlock", "Cedar.juniper", "Pine")])

# 4. Tamarack, Pine, Birch, Spruce, Poplar (TPBSP)
full.comps$Tamarack.Pine.Birch.Spruce.Poplar <- rowSums(full.comps[,c("Tamarack", "Pine", "Birch","Spruce", "Poplar")])


# 5. Elm, Oak, Basswood, Ironwood
full.comps$Elm.Oak.Basswood.Ironwood <- rowSums(full.comps[,c("Elm",  "Oak", "Basswood","Ironwood")])


         
compositions <- c( "Alder" ,"Ash","Bald.cypress"  ,     
 "Basswood","Beech","Birch" ,        
"Black.gum" , "Black.gum.sweet.gum" ,"Buckeye" ,           
"Cedar.juniper" ,  "Cherry"    ,"Chestnut"  ,         
 "Dogwood" ,  "Elm", "Fir",         
"Hackberry" , "Hemlock", "Hickory",            
 "Ironwood","Locust", "Maple" ,           
 "Mulberry" , "No.tree","Oak",                
 "Other.hardwood", "Other.softwood","Pine" ,              
 "Poplar", "Poplar.tulip.poplar", "Spruce" ,            
 "Sweet.gum" , "Sycamore" , "Tamarack"  ,         
"Tulip.poplar","Unknown.tree","Walnut" ,            
 "Willow", "Hemlock.Birch.Maple",              
"Hemlock.Beech.Maple","Cedar.Hemlock.Pine", "Tamarack.Pine.Birch.Spruce.Poplar","Elm.Oak.Basswood.Ironwood" )              

# make maps for all these compositions
for(i in 1:length(compositions)){
 
  map.comp <- ggplot(full.comps, aes(x,y, fill=full.comps[,compositions[i]]))+geom_raster()+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") +
  scale_fill_gradientn(colours = rev(terrain.colors(7)), limits = c(0,1), name =paste(compositions[i]," Composition"), na.value = 'darkgrey')+
  coord_equal()+theme_bw(base_size = 10)+ theme(legend.position = "bottom",axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())#+facet_wrap(~period)
 
map.comp

ggsave(filename=paste0("outputs/Composition/Maps/", compositions[i], "-maps.png"))
}

# make hexbin plots with all these compositions
for(i in 1:length(compositions)){
 
   hex.comp <- ggplot(full.comps, aes(PC1, full.comps[,compositions[i]]))+geom_hex() + 
    theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
   
     xlab('Environmental PC1') +ylab(paste("%", compositions[i]," Composition"))+facet_wrap(~period)
    
  hex.comp
  
  ggsave(filename=paste0("outputs/Composition/hexbin_plots/", compositions[i], "-hex.png"))
}

# make hexbin plots for all these compostions
for(i in 1:length(compositions)){
 
 hex.comp <- ggplot(full.comps, aes(PC1, full.comps[,compositions[i]]))+geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+xlab('Environmental PC1') +ylab(paste("%", compositions[i]," Composition"))+facet_wrap(~period)


hex.comp

ggsave(filename=paste0("outputs/Composition/hexbin_plots/", compositions[i], "-hex.png"))
}

# make histograms for all these compositions
for(i in 1:length(compositions)){
 
 
    comphist<- ggplot(full.comps, aes(full.comps[,compositions[i]], fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+xlab(compositions[i]) # 
  
  comphist
  
  ggsave(filename=paste0("outputs/Composition/full_hist/", compositions[i], "-hist.png"))
}

# Fix ordering of the PC1_bins factors
full.comps$PC1_bins_f2 <- factor(full.comps$PC1bins, levels = c("5 - 6", "4 - 5", "3 - 4",
                                                       "2 - 3", "1 - 2", "0 - 1", "-1 - 0",
                                                       "-2 - -1", "-3 - -2", "-4 - -3",
                                                       "-5 - -4"))

# plot the composition histograms by environment
for(i in 1:length(compositions)){
 
 
 
     comp.envt.hist <- ggplot(full.comps, aes(full.comps[,compositions[i]], fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f2, nrow = 3, scales = "free_y")+xlab(paste("% ",compositions[i], " composition"))
    
    comp.envt.hist
    
    ggsave(filename=paste0("outputs/Composition/envt_hist/", compositions[i], "-hist.png"))
}

#-------------------making the classifications from simons paper explicity----------




# plot histograms of all species by period:
comps.m <- melt(full.comps, id.vars = c("X.1","x","y", "cell","X","period","pc1" ,               "pc2" , "ecotype","bimodal","PC1" ,             
"PC2","PC1bins","PC2bins" , "PC1_bins_f", "PC1_bins_f2"))

allhists <- ggplot(comps.m, aes(value, fill = period))+geom_histogram(position = 'identity', alpha = 0.5)+facet_wrap(~variable, scales = "free_y")

png(width = 15, height = 10, units ="in",res = 300, "outputs/Composition/allhistograms.png")
allhists
dev.off()

# make histogrmas for each species over the range of climate
oakhists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Oak, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

hemhists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Hemlock, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

maphists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Maple, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

beechhists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Beech, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

Hickhists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Hickory, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

Tamhists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Tamarack, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

Sprucehists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Spruce, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

Elmhists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Elm, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")

Pinehists <- ggplot(full.comps[full.comps$ecotype %in% "Forest",], aes(Pine, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)+facet_wrap(~PC1_bins_f, nrow = 3, scales = "free_y")
# make species groups and plot histograms over the range of climate:
# using the groupings of lost forests outlined in simon's paper:

# 1. Hemlock, Birch, Maple (HBirM)




# full:
oakhistsfull <- ggplot(full.comps[full.comps$PC1_bins_f %in% c("0 - 1"),], aes(Oak, fill = period))+geom_histogram(position = 'identity', alpha = 0.7)


#-------------------------------plot the geom_denisty values below each hexbin plot:

# for Tree density:
dens.pr$PC1_bins_f2 <- factor(dens.pr$PC1bins, levels = c("5 - 6", "4 - 5", "3 - 4",
                                                       "2 - 3", "1 - 2", "0 - 1", "-1 - 0",
                                                       "-2 - -1", "-3 - -2", "-4 - -3",
                                                       "-5 - -4"))

# rename based on open, closed, and bimodal
dens.pr$newPCbins <- ifelse(dens.pr$PC1_bins_f2 %in% c("5 - 6", "4 - 5", "3 - 4","2 - 3", "1 - 2"), "Open (1-6 PC1)", ifelse(dens.pr$PC1_bins_f2 %in% c( "-3 - -2","NA"), "Closed (-3 - -2)", "Bimodal (-1 - 1)"))

dens.pr$newPCbins_f <- factor(dens.pr$newPCbins, levels=c("Closed (-3 - -2)", "Bimodal (-1 - 1)", "Open (1-6 PC1)"))
full<- dens.pr
full$period <- "Past"

# use BW of 40 to create smoother Unimoadal group
pls.density.hists <- ggplot(full, aes(PLSdensity, fill = period)) + geom_density(alpha = 0.5, position = 'identity', bw = 40) +xlim(0,700)+ xlab("Tree Density (trees/ha)")+ylab("Frequecny")+
  facet_wrap(~newPCbins_f, ncol = 3 , scales = "free_x")+theme_bw(base_size = 10)+scale_fill_manual(values = c("red", "blue"), limits = c("Modern", "Past"))+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())
#dev.off()
pls.density.hists

# for species composition:

full.comps$PC1_bins_f2 <- factor(full.comps$PC1bins, levels = c("5 - 6", "4 - 5", "3 - 4",
                                                       "2 - 3", "1 - 2", "0 - 1", "-1 - 0",
                                                       "-2 - -1", "-3 - -2", "-4 - -3",
                                                       "-5 - -4"))

# rename based on open, closed, and bimodal
full.comps$newPCbins <- ifelse(full.comps$PC1_bins_f2 %in% c("2 - 3", "1 - 2"), "Open", ifelse(full.comps$PC1_bins_f2 %in% c("-2 - -1" ,"-3 - -2", "NA","5 - 6", "4 - 5", "3 - 4", "-5 - -4", "-4 - -3"), "Closed/Mesic", "Bimodal (-1 - 1)"))

full.comps$newPCbins_f <- factor(full.comps$newPCbins, levels=c("Closed/Mesic", "Bimodal (-1 - 1)", "Open"))



# use BW of 40 to create smoother Unimoadal group
pls.comps.hists <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(pc2, fill = period)) + geom_density(alpha = 0.5, position = 'identity', bw = 0.3) +xlim(2.5,-6)+ xlab(expression(atop("Species Composition","Oak         " %<->% "        Mesic Species")))+ ylab("Frequecny")+
  facet_wrap(~newPCbins_f, ncol = 3 , scales = "free_x")+theme_bw(base_size = 10)+scale_fill_manual(values = c("red", "blue"), limits = c("FIA", "PLS"))+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())

png(height = 6, width = 6, units ="in",res=200,"outputs/paper_figs/oak_hists_envt.png")
oakhists <- ggplot(full.comps, aes(Oak, fill = period)) + geom_histogram(alpha = 0.5, position = 'identity')+facet_wrap(~PC1_bins_f2)+ylim(0,500)
oakhists
dev.off()

pls.oaks.hists <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(Oak, fill = period)) + geom_density(alpha = 0.5, position = 'identity') +xlim(0,1)+ xlab('% Oak Composition')+ ylab("Frequecny")+
  facet_wrap(~newPCbins_f, ncol = 3, scales = 'free_y' )+theme_bw(base_size = 10)+scale_fill_manual(values = c("red", "blue"), limits = c("FIA", "PLS"))+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())


pls.Maple.hists <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(Maple, fill = period)) + geom_density(alpha = 0.5, position = 'identity') +xlim(2.5,-6)+ xlab(expression(atop("Species Composition","Oak         " %<->% "        Mesic Species")))+ ylab("Frequecny")+
  facet_wrap(~newPCbins_f, ncol = 3 )+theme_bw(base_size = 10)+scale_fill_manual(values = c("red", "blue"), limits = c("FIA", "PLS"))+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())

pls.Hemlock.hists <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(Hemlock, fill = period)) + geom_density(alpha = 0.5, position = 'identity') +xlim(2.5,-6)+ xlab(expression(atop("Species Composition","Oak         " %<->% "        Mesic Species")))+ ylab("Frequecny")+
  facet_wrap(~newPCbins_f, ncol = 3 )+theme_bw(base_size = 10)+scale_fill_manual(values = c("red", "blue"), limits = c("FIA", "PLS"))+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())

pls.Beech.hists <- ggplot(full.comps[full.comps$period %in% "PLS",], aes(Beech, fill = period)) + geom_density(alpha = 0.5, position = 'identity') +xlim(2.5,-6)+ xlab(expression(atop("Species Composition","Oak         " %<->% "        Mesic Species")))+ ylab("Frequecny")+
  facet_wrap(~newPCbins_f, ncol = 3 )+theme_bw(base_size = 10)+scale_fill_manual(values = c("red", "blue"), limits = c("FIA", "PLS"))+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())


# use cowplot to add all these together

A <- arrangeGrob(pls.map, top = textGrob("A", x = unit(0.1, "npc")
         , y   = unit(1, "npc"), just=c("left","top"),
         gp=gpar(col="black", fontsize=18, fontfamily="Times Roman")))

B <- arrangeGrob(pls.Oak.map, top = textGrob("B", x = unit(0.1, "npc")
         , y = unit(1, "npc"), just=c("left","top"),
         gp=gpar(col="black", fontsize=18, fontfamily="Times Roman")))

C <- arrangeGrob(g, top = textGrob("C", x = unit(0.1, "npc")
        , y  = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black", fontsize=18, fontfamily="Times Roman")))

D <- arrangeGrob(ocomp+theme_bw(), top = textGrob("D", x = unit(0.1, "npc")
        , y = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))

E <- arrangeGrob(pls.dens.hex, top = textGrob("E", x = unit(0.1, "npc")
        , y = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))

Fp <- arrangeGrob(pls.oak.hex, top = textGrob("F", x = unit(0.1, "npc")
        , y = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))

G <- arrangeGrob(pls.density.hists, top = textGrob("G", x = unit(0.1, "npc")
        , y = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))
H <- arrangeGrob(pls.oaks.hists, top = textGrob("H", x = unit(0.1, "npc"), 
        y = unit(1.1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))


# take all these figures and mash into one big mega figure
png(height = 10, width = 10, units = "in", res = 300, "outputs/paper_figs/fig2oak.png")
grid.arrange(A,B,C,D,E,Fp,G,H, ncol = 2, nrow=4) 
dev.off()

###############################################################################
# New figure 3--FIA figures
###############################################################################

# fia density data map:
densitys <- read.csv("data/midwest_pls_fia_density_alb1.6-5.csv")
fia.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=densitys, aes(x=x, y=y, fill = FIAdensity))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing")+ #+ 
  scale_fill_gradientn(colours = cbpalette, limits = c(0,600), name ="Tree \n Density \n (trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())


png("/Users/kah/Documents/bimodality/outputs/paper_figs/fia_density_map.png")
fia.map
dev.off()

# fia composition map:
# read in the composition data for PLS and FIA (PC1 and PC2):
full.comps<- read.csv("outputs/cluster/fullcomps_dataset.csv")

fia.comp.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "FIA",], aes(x=x, y=y, fill = pc2))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(-10.5,3), name ="Species \n composition \n PC2", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())

# make a map of Oak composition:
fia.Oak.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "FIA",], aes(x=x, y=y, fill = Oak))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Oak Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())


# make a map of Maple composition:
fia.Maple.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "FIA",], aes(x=x, y=y, fill = Maple))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Maple Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())

# make a map of Hemlock composition:
fia.Hemlock.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "FIA",], aes(x=x, y=y, fill = Hemlock))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Hemlock Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())

# make a map of Beech composition:
fia.Beech.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full.comps[full.comps$period %in% "FIA",], aes(x=x, y=y, fill = Beech))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing") + 
  scale_fill_gradientn(colours = rev(rainbow(3)), limits = c(0,1), name ="Beech Composition", na.value = 'darkgrey') +
  coord_equal() + theme_bw(base_size = 10)+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())




# fia density vs. envt:
fia.dens <- read.csv("outputs/FIA_pls_density_with_bins.csv")
fia.dens.hex <- ggplot(fia.dens, aes( PC1fia, FIAdensity)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab(" FIA Tree Density /n (stems/ha)")


#fia composition vs. envt:
# use full.comps:
fia.comp.hex <- ggplot(full.comps[full.comps$period %in% "FIA",], aes(PC1, pc2)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Species Composition PC2")

# oak composition hex
fia.oak.hex <- ggplot(full.comps[full.comps$period %in% "FIA",], aes(PC1, Oak)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Oak Composition PC2")

#maple hex
fia.maple.hex <- ggplot(full.comps[full.comps$period %in% "FIA",], aes(PC1, Maple)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Species Composition PC2")

fia.hemlock.hex <- ggplot(full.comps[full.comps$period %in% "FIA",], aes(PC1, Hemlock)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Species Composition PC2")

fia.beech.hex <- ggplot(full.comps[full.comps$period %in% "FIA",], aes(PC1, Beech)) +geom_hex() + 
  theme_bw(base_size = 10)+scale_fill_distiller(palette = "Spectral", limits = c(1,130))+
  xlab('Environmental PC1') +ylab("Species Composition PC2")


# ---------------fia density ghost figures:
# for Tree density:

fia <- fia.dens[,c("x","y","cell", "FIAdensity", "PC1fia", "PC1fiabins")]
colnames(fia) <- c("x","y","cell", "density", "PC1", "PC1bins")
fia$period <- "Modern"
pls <- dens.pr[,c("x","y","cell", "PLSdensity", "PC1", "PC1bins")]
colnames(pls) <- c("x","y","cell", "density", "PC1", "PC1bins")
pls$period <- "Past"

full.dens<- rbind(pls, fia)

full.dens$PC1_bins_f2 <- factor(full.dens$PC1bins, levels = c("5 - 6", "4 - 5", "3 - 4",
                                                       "2 - 3", "1 - 2", "0 - 1", "-1 - 0",
                                                       "-2 - -1", "-3 - -2", "-4 - -3",
                                                       "-5 - -4"))

# rename based on open, closed, and bimodal
# rename based on open, closed, and bimodal
full.dens$newPCbins <- ifelse(full.dens$PC1_bins_f2 %in% c("5 - 6", "4 - 5", "3 - 4","2 - 3", "1 - 2"), "Open (1-6 PC1)", ifelse(full.dens$PC1_bins_f2 %in% c( "-3 - -2","NA"), "Closed (-3 - -2)", "Bimodal (-1 - 1)"))

full.dens$newPCbins_f <- factor(full.dens$newPCbins, levels=c("Closed (-3 - -2)", "Bimodal (-1 - 1)", "Open (1-6 PC1)"))


# use BW of 40 to create smoother Unimoadal group
fia.density.hists <- ggplot(full.dens, aes(density, fill = period, alpha = period, linetype = period)) + geom_density( position = 'identity', bw = 40) +xlim(0,700)+ scale_alpha_discrete(limits=c("Past", "Modern"),range=c(0.1, 1), guide = FALSE)+xlab("Tree Density (trees/ha)")+ylab("Frequecny")+
  facet_wrap(~newPCbins_f, ncol = 3 , scales = "free_x")+theme_bw(base_size = 10)+scale_fill_manual(values = c("red", "blue"), limits = c("Modern", "Past"))+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())


# fia composition ghost figures:
fia.comps.hists <- ggplot(full.comps, aes(pc2, fill = period, alpha = period, linetype = period)) + geom_density(position = 'identity', bw = 0.3)+ scale_alpha_discrete(limits=c("PLS", "FIA"),range=c(0.1, 1), guide = FALSE)+xlim(2.5,-6)+ xlab(expression(atop("Species Composition","Oak         " %<->% "        Mesic Species")))+ ylab("Frequecny")+scale_fill_manual(values = c("red", "blue"), limits = c("FIA", "PLS"))+
  facet_wrap(~newPCbins_f, ncol = 3 , scales = "free_x")+theme_bw(base_size = 10)+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())


fia.oaks.hists <- ggplot(full.comps, aes(Oak, fill = period, alpha = period, linetype = period)) + geom_density(position = 'identity')+ scale_alpha_discrete(limits=c("PLS", "FIA"),range=c(0.1, 1), guide = FALSE)+xlim(0,1)+ xlab("% Oak Composition")+ ylab("Frequecny")+scale_fill_manual(values = c("red", "blue"), limits = c("FIA", "PLS"))+
  facet_wrap(~newPCbins_f, ncol = 3 , scales = "free_x")+theme_bw(base_size = 10)+coord_flip()+theme(axis.title.x=element_blank(), axis.text.x=element_blank(),                                                          axis.ticks.x=element_blank())

# now put them all together into one figure:
Af<- arrangeGrob(fia.map, top = textGrob("A", x = unit(0.1, "npc")
         , y   = unit(1, "npc"), just=c("left","top"),
         gp=gpar(col="black", fontsize=18, fontfamily="Times Roman")))

Bf <- arrangeGrob(fia.Oak.map, top = textGrob("B", x = unit(0.1, "npc")
         , y = unit(1, "npc"), just=c("left","top"),
         gp=gpar(col="black", fontsize=18, fontfamily="Times Roman")))

Cf <- arrangeGrob(fia.dens.hex, top = textGrob("C", x = unit(0.1, "npc")
        , y  = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black", fontsize=18, fontfamily="Times Roman")))

Df <- arrangeGrob(fia.oak.hex, top = textGrob("D", x = unit(0.1, "npc")
        , y = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))

Ef <- arrangeGrob(fia.density.hists, top = textGrob("E", x = unit(0.1, "npc")
        , y = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))

Ff <- arrangeGrob(fia.oaks.hists, top = textGrob("F", x = unit(0.1, "npc")
        , y = unit(1, "npc"), just=c("left","top"),
        gp=gpar(col="black",    fontsize=18, fontfamily="Times Roman")))




# take all these figures and mash into one big mega figure
png(height = 10, width = 10, units = "in", res = 300, "outputs/paper_figs/fig3_oaks.png")
grid.arrange(Af,Bf,Cf,Df,Ef,Ff, ncol = 2, nrow=3) 
dev.off()


##################################
fig1D<- ggplot(densitys, aes(FIAdensity)) +geom_histogram(binwidth = 30,fill ="#0072B2",  color = 'black') +xlim(0, 700)+xlab('Modern Tree density (stems/ha)')+ylab("# grid cells")+
        theme_bw(base_size = 10)+ annotate("text", x=0, y=900,label= "D", size = 5)+theme(legend.title=element_blank())

densitys.m <- melt(densitys, id.vars = c('X', 'x', 'y', 'cell'))

png(height = 3, width = 4, units = 'in', res= 300,"outputs/PLS_FIA_overlaid_hist.png")
ggplot(densitys.m, aes(value, fill = variable)) +geom_histogram(binwidth = 29, alpha=0.7, position = "identity")+scale_fill_manual(values = c("#ef8a62", "#67a9cf"), limits = c('FIAdensity', "PLSdensity")) +xlim(0, 700)+xlab('Tree density (stems/ha)')+ylab("# grid cells")+theme_bw(base_size = 10)
dev.off()

png(height = 3, width = 4, units = 'in', res= 300,'outputs/PLS_only_hist_dens.png')
ggplot(densitys.m[densitys.m$variable == "PLSdensity",], aes(value, fill = variable)) +geom_histogram(binwidth = 29, alpha=0.7, color = 'black', position = "identity")+scale_fill_manual(values = c( "#67a9cf"), limits = c( "PLSdensity")) +
  xlim(0, 700)+xlab('Tree density (stems/ha)')+ylab("# grid cells")+theme_bw(base_size = 10)
dev.off()

png(height = 3, width = 4, units = 'in', res= 300,"outputs/FIA_only hist_dens.png")
ggplot(densitys.m[densitys.m$variable == "FIAdensity",], aes(value, fill = variable)) +geom_histogram(binwidth = 29, alpha=0.7, color = 'black', position = "identity")+scale_fill_manual(values = c("#ef8a62"), limits = c('FIAdensity')) +
  xlim(0, 700)+xlab('Tree density (stems/ha)')+ylab("# grid cells")+theme_bw(base_size = 10)
dev.off()

dens <- densitys
dens$diff <- dens$FIAdensity - dens$PLSdensity

# density difference plots
fig1E <- ggplot(dens, aes(x = PLSdensity, y = diff))+ geom_point()+geom_density_2d() +geom_smooth(method = 'lm', color = 'red')+xlim(0,600)+
  theme_bw()+ ylab('density difference (trees/ha)') + xlab('PLS tree density (trees/ha)') + annotate("text", x=0, y=900,label= "E", size = 5)


# plot bimodal climate space:
bimodalpls <- read.csv("outputs/PLS_full_dens_pr_bins_with_bimodality_for_PC1.csv") 

fig1B <- ggplot(bimodalpls, aes(x = MAP1910, y = pasttmean))+ geom_point()+ 
  stat_density2d(data = bimodalpls, aes(colour = bimodal),fill = "transparent",geom="polygon") +
  theme_bw()+ ylab ("Mean Temperature (degC)") + xlab("Mean Annual Precipitation (mm/yr), 1895-1925") + annotate("text", x=400, y=15,label= "B", size = 5)+theme(legend.key.size = unit(0.5,'lines'), legend.position = c(0.8, 0.2), legend.title=element_blank())

# plot out bimodal maps for pls and FIA
library(modes)
library(diptest)

# function to determine places that are bimodal and map these out in space:

source("R/map.bimodal.5c.R")

dens.pr <- read.csv("data/PLS_full_dens_pr_with_bins.csv")

fig1C <- map.bimodal.5c( data = dens.pr, binby = 'PC1bins', density = "PLSdensity" )+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.4,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1))+ annotate("text", x=-90000, y=1486000,label= "C", size = 5)

png("outputs/PLS_5c_bimodality_denisity_map.png")
fig1C
dev.off()

fia.dens <- read.csv("outputs/FIA_pls_density_with_bins.csv")

fig1F <- map.bimodal.5c( data = fia.dens, binby = 'PC1fiabins', density = "FIAdensity" )+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.4,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1))+ annotate("text", x=-90000, y=1486000,label= "F", size = 5)


source('R/bimodal.df.R')
a <- bimodal.df( data = dens.pr, binby = 'PC1bins', density = "PLSdensity" , binby2 = "PC1bins")
b <- bimodal.df( data = dens.pr, binby = 'PC1bins', density = "PLSdensity" , binby2 = "PC1fiabins")

# plot of pls with pls climate and pls with fia climate
ggplot(b, aes(x, y, fill = bimodal))+geom_raster()
ggplot(a, aes(x, y, fill = bimodal))+geom_raster()

nrow(b[b$bimodal == "Bimodal",])*8*8 # modern projected bimodal 
nrow(a[a$bimodal == "Bimodal",])*8*8 # historic bimodal

difference <- (nrow(a[a$bimodal == "Bimodal",])*8*8)  - (nrow(b[b$bimodal == "Bimodal",])*8*8)

pctdifference <- (((nrow(a[a$bimodal == "Bimodal",])*8*8)  - (nrow(b[b$bimodal == "Bimodal",])*8*8))/(nrow(a[a$bimodal == "Bimodal",])*8*8))*100
# Write out to a png to control size
 
#plot out the region that should be bimodal under modern climate
png(width = 5, height = 4, units='in',res=300,'outputs/paper_figs/supplemental_modern_climaate_pls_data.png')

mod.pls<- ggplot(b, aes(x, y, fill = bimodal))+geom_raster()+
      theme_bw()+ theme(axis.line=element_blank(),axis.text.x=element_blank(),
                        axis.text.y=element_blank(),axis.ticks=element_blank(),
                        axis.title.x=element_blank(),
                        axis.title.y=element_blank())+
      scale_fill_manual(values = c("red", 'blue'), limits= c("Bimodal", "Unimodal"))+
      xlab("easting") + ylab("northing") +coord_equal() 
mod.pls
dev.off()

# make figure 1 with all the panels
png(width = 7, height = 9, units = "in", res= 300,"outputs/paper_figs/Figure_1.png")
grid.arrange(arrangeGrob(fig1A, fig1D, fig1B, fig1E, fig1C, fig1F, heights=c(1/2, 1/2, 3/4), widths=c(1.1,1.1), ncol=2))
dev.off()


# using plotly to make density plots of the data:
library(plotly)
test <- dens.pr[,c("PC1","PLSdensity")]
test <- test[complete.cases(test),]
kd <- MASS::kde2d( test$PC1,test$PLSdensity, n = 25)
p <- plot_ly(x = kd$x, y = kd$y, z = kd$z) %>% add_surface()%>%
  layout(
    title = "Layout options in a 3d scatter plot",
    scene = list(
      xaxis = list(title = "PC1 environment"),
      yaxis = list(title = "Tree Density"),
      zaxis = list(title = "frequency")
    ))


p




#lets see how many bimodal grid cells are not in the FIA datasets now:
bimodal.cells <- bimodalpls[bimodalpls$bimodal == 'Bimodal',]$cell

bimodal <- bimodalpls[bimodalpls$bimodal == 'Bimodal',]

fcellsbim <- fia.dens[fia.dens$cell %in% bimodal.cells,]

prop.bimodal <- nrow(fcellsbim)/nrow(bimodal)
# 45.1 percent of bimodal places fall within the FIA dataset
fcell <- fcellsbim$cell
# lets see how many of bimodal forest/bimodal forests places have been removed

notinfia <- bimodal[!bimodal$cell %in% fcell, ]

infia <- bimodal[bimodal$cell %in% fcellsbim$cell, ]

# how much of each ecotype have we lost?
summary(infia$bimodal)
summary(notinfia$bimodal)

# places that are no longer in the FIA:
notinfia.eco<- summary(notinfia[notinfia$bimodal == "Bimodal",]$ecotype)
notinfia.eco*8*8 # find the square km of historically bimodal forest and savanna lost

# places that are still in the FIA:
infia.eco<- summary(infia[infia$bimodal == "Bimodal",]$ecotype)
infia.eco*8*8 # find the square km of historically bimodal forest and savanna still present on modern landscape
total.bimodal<- nrow(bimodalpls[bimodalpls$bimodal == 'Bimodal',])*8*8 
total.bimodal/(nrow(bimodalpls)*8*8)  # percent of the Bimodal area in the past


# find the pwercent of each that was lost and remaining
((infia.eco*8*8) / total.bimodal)*100
((notinfia.eco*8*8) / total.bimodal)*100
ggplot(infia, aes(x = x, y = y, color = bimodal))+geom_point()


ggplot(notinfia, aes(x = x, y = y, fill = biomdal))+geom_raster()

#make a plot of the places removed
# bar plot or plot showing proportion of these
notinfia$count <- 1

lost.table <- count(df = notinfia, vars = c('classification'))


kept.table <- count(df= infia, vars = c('classification'))

ggplot(lost.table, aes(x = classification, y = freq))+geom_bar(stat='identity')+ggtitle('grid cells lost in FIA')

ggplot(kept.table, aes(x = classification, y = freq))+geom_bar(stat='identity')+ggtitle('grid cells still in FIA')
```




### Figure 2: 2 maps of rcp 8.5 
Projected stability of the Midwestern vegetation in 2070-2099 based on RCP8.5 CMIP5 climate projections from model CCESM4 and historic vegetation-environment relationships (A), and modern vegetation-environment relationships (B). Bimodal places in the future are those with climates matching the bimodal climate space (based on PC1) in the past and modern landscape respectively. No-analog climates were determined with respect to the climate space of the past in (A), and with respect to modern climate in (B).
```{r, echo=FALSE,warning = FALSE}

dens.pr <- read.csv("data/PLS_full_dens_pr_with_bins.csv")

source("R/map.future.scenarios.R")


a <- bimodal.future.NA(data = na.omit(dens.pr), binby = 'PC1_cc60bins', density = "PLSdensity", binby2 ='PC1_cc60bins', rcp = "60" ) + ggtitle ("RCP 6.0 PC1")+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "C", size = 5)+ggtitle("")

b <- bimodal.future.NA(data = na.omit(dens.pr), binby = 'PC1_cc26bins', density = "PLSdensity", binby2 ='PC1_cc26bins',  rcp = "26") + ggtitle("RCP 2.6 PC1")+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "A", size = 5)+ggtitle("")

c <- bimodal.future.NA(data = na.omit(dens.pr), binby = 'PC1_cc85bins', density = "PLSdensity", binby2 ='PC1_cc85bins', rcp = '45' )+ ggtitle("RCP 8.5")+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(2,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),legend.text=element_text(size=15),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank()) +ggtitle(" ")
png(height=6, width = 6, units="in", res=300,"outputs/RCPpreds/map_PLSdens_rcp8.5.png")
c
dev.off()


png(width = 12, height=4, units="in", res=300, "outputs/paper_figs/PLS_supplemental_rcp_map.png")
grid.arrange(b, c, a, ncol = 3)
dev.off()



fig2a <- bimodal.future.NA(data = dens.pr, binby = 'PC1_cc26bins', density = "PLSdensity", binby2 ='PC1_cc85bins', rcp = '85' )+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "A", size = 5)+ggtitle("")


# for the FIA data


af <- bimodal.future.rNA(data = fia.dens, binby = 'PC1fiabins', density = "FIAdensity", binby2 ='PC1_cc60fbins', rcp = "60" ) + ggtitle ("RCP 6.0 PC1")+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "C", size = 5)+ggtitle("")


bf <- bimodal.future.rNA(data = fia.dens, binby = 'PC1fiabins', density = "FIAdensity", binby2 ='PC1_cc26fbins',  rcp = "26") + ggtitle("RCP 2.6 PC1")+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "A", size = 5)+ggtitle("")

cf <- bimodal.future.rNA(data = fia.dens, binby = 'PC1fiabins', density = "FIAdensity", binby2 ='PC1_cc45fbins', rcp = '45' )+ ggtitle("RCP 4.5 PC1")+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "B", size = 5)+ggtitle("")

df <- bimodal.future.rNA(data = fia.dens, binby = 'PC1fiabins', density = "FIAdensity", binby2 ='PC1_cc85fbins', rcp = '45' )+ ggtitle("RCP 8.5 PC1")+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(2,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),legend.text=element_text(size=15),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ggtitle("") #+ annotate("text", x=-90000, y=1486000,label= "B", size = 5)+ggtitle("")

# output on only a map of FIA based prediations for RCP8.5
png(height=6, width = 6, units="in", res=300, "outputs/RCPpreds/map_FIAdens_rcp8.5.png")
df
dev.off()

png(width = 12, height=4, units="in", res=300, "outputs/paper_figs/FIA_supplemental_rcp_map.png")
grid.arrange(bf,cf,af, ncol = 3)
dev.off()

fig2b <- bimodal.future.rNA(data = fia.dens, binby = 'PC1fiabins', density = "FIAdensity", binby2 ='PC1_cc85fbins', rcp = '85' )+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "B", size = 5)+ggtitle("")



png(width = 8, height=4, units="in", res=300, "outputs/paper_figs/Fig_2.png")
grid.arrange(fig2a, fig2b, ncol = 2)
dev.off()


# making figure S3: map of modern climate classified using pls-veg-climate relaitonships

pls.mod.clim<- bimodal.pls.mod(data = dens.pr, binby = 'PC1bins', density = "PLSdensity", binby2 ='PC1fiabins' )+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ggtitle("")

png(width = 4, height=4, units="in", res=300, "outputs/paper_figs/Fig_S3_plsvegclim_with_mod_clim.png")
pls.mod.clim
dev.off()


```






```{r, echo = FALSE}

# calculate the area that is bimodal
df.new <- bimodal.df(data = dens.pr, binby = 'PC1bins', density = "PLSdensity", binby2 = 'PC1bins')
df.mod <- bimodal.df(data = dens.pr, binby = 'PC1bins', density = "PLSdensity", binby2 = 'PC1fiabins')
df.8.5 <- bimodal.df(data = dens.pr, binby = 'PC1bins', density = "PLSdensity", binby2 = "PC1_cc85bins")
df.4.5 <- bimodal.df(data = dens.pr, binby = 'PC1bins', density = "PLSdensity", binby2 = "PC1_cc45bins")
df.2.6 <- bimodal.df(data = dens.pr, binby = 'PC1bins', density = "PLSdensity", binby2 = "PC1_cc26bins")

# calculate the % that should be bimodal in the modern landscape
a <- nrow(df.mod[df.mod$bimodal == "Bimodal",])/nrow(df.mod)
b <- nrow(df.new[df.new$bimodal == "Bimodal",])/nrow(df.new)
c <- nrow(df.8.5[df.8.5$bimodal == "Bimodal",])/nrow(df.8.5)
d <- nrow(df.4.5[df.4.5$bimodal == "Bimodal",])/nrow(df.4.5)
e <- nrow(df.2.6[df.2.6$bimodal == "Bimodal",])/nrow(df.2.6)
plsgrd <- nrow(df.new[df.new$bimodal == "Bimodal",])/nrow(df.new)
plspct <- nrow(df.new[df.new$bimodal == "Bimodal",])*64


a
b
c
d
e


```










  
Supplemental Material:   
Supplemental figures:

```{r, echo = FALSE}

#map out 
all_states <- map_data("state")
states <- subset(all_states, region %in% c(  'minnesota','wisconsin','michigan',"illinois",  'indiana') )
coordinates(states)<-~long+lat
class(states)
proj4string(states) <-CRS("+proj=longlat +datum=NAD83")
mapdata<-spTransform(states, CRS('+init=epsg:3175'))
mapdata <- data.frame(mapdata)
#################################
#plot maps of tree density
#################################
#dens.pr<- data.frame(dens.pr)


sc <- scale_colour_gradientn(colours = rev(terrain.colors(8)), limits=c(0, 16))
cbpalette <- c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837")
cbPalette <- c("#999999","#009E73", "#E69F00", "#56B4E9",  "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


# map out the pls map:
pls.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=dens.pr, aes(x=x, y=y, fill = PLSdensity))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="PLS tree density") + scale_fill_gradientn(colours = cbpalette, limits = c(0,700), name ="Tree Density \n(trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw()+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'),legend.title=element_text(size=10),legend.position = c(0.205, 0.32),legend.background = element_rect(fill=alpha('transparent', 0)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1))+ annotate("text", x=-90000, y=1486000,label= "A", size = 5)+ggtitle("")


# map out the fia data
fia.map <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=fia.dens, aes(x=x, y=y, fill = FIAdensity))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="PLS tree density") + scale_fill_gradientn(colours = cbpalette, limits = c(0,700), name ="Tree Density \n(trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw()+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'),legend.title=element_text(size=10),legend.position = c(0.205, 0.32),legend.background = element_rect(fill=alpha('transparent', 0)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1))+ annotate("text", x=-90000, y=1486000,label= "B", size = 5)+ggtitle("")

png(width = 8, height=4, units="in", res=300, "outputs/paper_figs/Fig_S1.png")
grid.arrange(pls.map, fia.map, ncol = 2)
dev.off()


```


![](outputs/v1.6-5/tree_density_maps_PLS_FIA.png)
![](outputs/v1.6-5/PLS__full_tree_density_map.png)

*Generalized Additive Models/Relationship between historic vegetation and climate/soil variables*

Gam model selection for the model with the lowest AIC value yeilded the model: tree density ~ s(MAP) + s(mean annual temperatue) + s(deltaT) + s(deltaP) + s(sandpct) + s(awc). While AIC suggests this is the best model (Table 1), it only explains 61% of the Deviance and has high Mean squared prediction error for predicting the test data set (MSPE = 5976.366). Prediction of tree density is overestimated in low tree denisty grid cells and underestimated in high tree denisty grid cells.  

The Gam model for the modern landscape explained only 29 % of the deviance and had a high mean squared prediction error for predicting the test data set (MSPE = XXXX). Prediction of tree density is again overestimated in low tree denisty grid cells and underestimated in high tree density grid cells. 


## Supplemental Methods:
*Public Land Survey Data:*
The Public Land Survey was commissioned by the U.S. General Land Office to assess the quality of land/timber and assign land titles for Euro-american settlers. The surveyors placed corner posts at 1 mile section corners in a grid within each township. At these section corners, and at 1/4 section corners, the surveyors would record the distance and azimuth from the corner to the nearest two trees, the species of the nearest two trees, and the diameter at breast height (DBH) of those trees. After these historic records were digitized (cite Mladenoff et al. ), we estimate the denisty and basal area at each corner point using the unbiased morista density estimator with correction factors for surveyor bias (@goring_2016, CITE Cogbill). Tree density is averaged across 8km x 8km grid cells in the upper Midwest.

*Forest Inventory Analysis Data:*

Add FIA data methods from Sean/Simon/Jack. FIA estimated tree denisty is also aggregated to the same 8km raster grid resolution.

*Climate Data*

  Mean annual temperature and Mean annual Precipitation data for the modern and historic vegetation-climate relationships are from PRISM datasets. Modern mean annual temperature and precipitation fore each 8km grid cell is calculated from the 800m 30-year Normals dataset. Historical climate is estimated as the average annual Temperature and average annual Precipiation over the 1895-1910 period. While this historical climate period does not overlap with the entirety of the European agricultural settlement era, this climatic period is the oldest for which we have reliable estimates of temperature and precipitation in the region. Precipitation seasonality was calculated from Monthly Prism datasets as follows: 

SI = sum 1-12(abs(mi - P/12))/P * 100

Temperature is calculated using the coefficient of variation method
TSI = sd(m1....m12)/Tavgannual *100
 
  
*Soil data*

  Soils data are derived from statewide gSSURGO 10m raster data product (<https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/home/?cid=NRCS142P2_053628>).  The weighted averages from the top 30cm of the soil were calculated for % sand, available water content (awc), and saturated hydraulic conductivity (ksat) soil parameters using the gSSURGO On-Demand ArcGIS toolbox (<https://github.com/ncss-tech/ssurgoOnDemand.git>). Weighted averages were calculated on the statewide soil raster datasets for Minnesota, Michigan, Wisconsin, Indiana, and Illinois, then weighted average rasters were mosaicked together to produce one single raster dataset. Maps of soil parameters were then aggregated to a 1km grid scale and an 8km Great Lakes St. Lawrence projected grid scale (PalEON dataset scale).

*Pricipal Component Analysis*

Since many climate and soils variables are often correlated, a pricipal components analysis was conducted to reduce dimensions and co-linearity in the environmental data. PCA was coducted on the scaled variables of historic MAP, historic Mean temperature, historic Precipitation Seasonality Index, Historic Tempearture Seasonality, AWC, and %sand. The modern principal component scores for climatic and soil variables were predicted using the historic principal component model. This method maintains the PCA of modern and historic environmental data on the same scale. The 1st Principal Component (PC1) was then used as a covariate when assessing bimodality. 

  
*Bimodality analysis*

Criteria for bimodality uses a both a bimodality coefficient (BC) and Hartigans Diptest for unimodality. Bimodality Coefficient is calculated from size, skewness, and kurtosis of the distributions (Pfister et al. 2013). A BC greater than 0.556 suggests bimodality. Bimodality coefficient (BC) is calculated from the distribuiton of data as follows using the R package 'modes':

BC = $\frac{(skew^2 + 1)}{(kurtosis + 3)*\frac{(n-1)^2}{(n-2)*(n-3)}}$

Desnity distributions of the PLS and FIA data were estimated. We then calculated the BC and performed Hartigan's diptest for unimodaltity for the on these smoothed density distribuitons for the PLS and FIA overall, and the BC within different bins of precipitation and the 1st Principal Component. Hartigan's diptest has a null hypothesis of a unimodal distribution of the data (CITE). This provides one BC value for a given range of precipitation/PC and whether the distribution is significantly different from a unimodal distribution. These ranges are used to determine the climate space where savannas and closed forests coexist.  

*Generalized Additive Models*

In addition to evaluating the BC for ranges of data, we developed several generalized additive models (GAMs) to determine if tree density can be deterministically predicted by climate and/or soils. GAMs were developed with both strictly additive terms and with flexible smooth terms. The full PLS data and FIA data were separated into two random halves that make up the testing and training datasets. GAM's were developed with the training dataset, and prediction error was estimated using the test dataset. Model parsimony was evaluated basing on AIC values, and model fit was assessed using RMSE. 

*Future Forest Stability under CMIP5 projected climate scenarios*

To investigate the consequences of the modern climate-vegetation relationship, and the past climate-vegetation relatiohsip would have for the stability of future midwestern forests, we utilized climate projections from CMIP5 representative concentration pathways (rcps) 2.6, 4.5, and 8.5. We obtained average monthly precipitation, total annual precipitation, average monthly temperature, and average annual temperature projections for 2070-2099 under the three RCP scenarios from the CCESM4 GCM climate downscaled climate projections (from worldclim, cite). We calculated precipitation and temperature seasonality as described above. Principal componenet scores (based on the past climate PCA) were assigned for each grid cell using the projected climate data from each RCP. 

We then identified the climate space (within PC1) that was bimodal in the PLS time, and mapped where this climate space is projected to be in 2070-2100. We also identified the climate space where FIA forests were bimodal on the modern landscape, and where this climate space would be in 2070-2100.



## Discussion:

  Tree density in the past was significantly bimodal, and was not accounted for by climate or soil factors, supporting our hypothesis that savannas and forests were alternative stable states in the region.  Projecting the past climate-vegeation relationship onto the modern climate would drive shifts in the climate space where bistable tree distributions are possible, but continue to predict large extent of savanna and forest alternative stable states on the modern landscape. However, modern tree density is no longer bimodal on the modern landscape, suggesting an unexpected shift towards stable closed forests in the region. Neither past tree density nor modern tree density has a fully deterministic relationship with climate, but bimodality in past tree density is predominant at intermediate temperature and precipitation space.  These largescale shifts from alternative savanna and forest stable states towards stable closed forests indicate that land use changes (fire suppression, logging, agricultural conversion) have had a far greater impact on midwestern woody ecosystems than changes in climate over the last ~150 years.  
  
  Land use changes that have led to fire suppression and land conversion in the region have long been hypothesized to drive "mesophication" (Nowacki and Abrams 2008), and increases in woody cover in the region. Additionally, small scale studies indicate that historic geography that would act as fire breaks (rivers and topography) are important explanatory variables for PLS vegetation (Grimm 1984). Modern land management strategies for restoring open savannas and grasslands in the region require extensive cutting and prescribed burns to limit understory tree growth (CITE). (CITE) suggest that a shift in overall fire return intervals have shifted southern midwest savanna and grasslands towards mesophytic forests and require larger and longer efforts of prescribed burns to return these ecosystems to their open states. While there has been small scale evidence that fire and disturbances were historically important for the maintence of temperate savanna-forest boundary in the US, our study is the first to document evidence for alternative savanna and forest stable states across a large region of the midwest. Additionally, the modern landscape after long term land use changes and post-settlement fire suppression has become mostly stable forests. 
  
  Evidence for alternative savanna and forest stable states in the temperate Midwest provides evidence that bistable systems are not constricted to the tropics. In the tropics, intermediate precipitation and high precipiation seasonality is the climatic domain for alternative stable states. However, our finding of temperate alternative stable states at much lower precipitaiton levels and temperatures, indicate that the constraints on growth identified in the tropics do not impose hard limits on the extent of these systems globally. Rather, we propose that alternative stable states are constrained to regions of intemediate moisture, where disturbance feedbacks occur. 

  Overall the shifts between the modern landscape and the pre-European settlement is marked by large scale forest stabilization, a shift from bimodal distribution in tree cover characterized by closed forests and open savannas, to mostly closed forested ecosystems. Throughtout the holocene, shifts in tree composition and tree cover have been linked to climatic variability across the region (CITE). However, this recent shift is not predicted by the observed changes in temperature, precipitation, or T/P seasonality. Rather, we propose that increased fire suppression and removal of disturbances from the landscape as likely mechanisms for overall shift towards closed forests. However, lack of direct evidence for the mechanism of these shifts makes it difficult to direct attribute the cause. Additonally, increases in atmospheric CO2 have been hypothesized to have a CO2 fertilization effect on tree growth, and could increase forest cover by increasing growth and tree recruitment (Wycoff and Bowers, CITE recruitment paper). To determine how much a CO2 fertilization effect may have contributed to increased forest cover in the Midwest, mechanistic evidence for CO2 fertilization in the region is needed. 
  
  The distribution of tree density across the region and the stabiliity of ecosystems to envrionmental changes can have large consequences for future biodiversity, carbon storage, and management decisions. Although evidence for alternative savanna and forest stable states in the midwest and throughout the globe suggest the potential for large scale forest/biome instability with changes in climate, ongoing land use changes and fires suppression have historically stabilized forests in the midwest. While increased stability of terrestrial ecosytems is a positive effects of the "mesophication" and overall conversion of savannas and grasslands to forests, it may come at the large cost of species biodiversity loss, increased vegetation homogenity, and loss of habitat. Assuming current land cover strategies continue, the modern forests are not likely to revert back to savanna in response of climate. However, increased likelihood of fire disturbances and further land use changes that may accompany changes in climate could alter the stability of the region. Being able to identify forest stability, and vegetation responses to different types of environmental changes will be important to understanding the trajectory of future forest and savanna biomes.  
  





# Supplemental Figures:
Additionally, the biplot for the Principal Components Analysis:
![](outputs/v1.6-5/full/pca_biplot.png)



# Climate space where the bimodality occurs: (3d plots):

![](outputs/3d_1.png)
![](outputs/3d_2.png)

We predict the binomial probability of having closed forest (tree density over 47 trees/hectare) given precipation, temperature, precip seasonality, temperature seasonality, % sand and awc. We get a decrease in probability of forests predicted in the open savanna regions, but the places with intermediate probability suggest unstable intermediates where savannas and forests are equally probable given the environmental data.


![](outputs/v1.6-5/full/logistic_pred_prob_testdata.png)

Here is the mapped distribution if we used the whole dataset (note this includes both training and testing dataests, I just wanted to look at a non-pixelated map)

![](outputs/v1.6-5/full/logistic_pred_prob_full.png)

# Tables with GAM model fits for PLS grid cells where we document unimodal distributions in tree cover:

# Issues with the GAM models: some models are predicting a few grid cells to be negative density (at the tails). Likely due to gaussian distn. family that was picked. The GLM models do not predict the negative density values, but still underestimate the low denisty places

Table 1: PLS density GAM models for stable sites
```{r, echo = FALSE, warning = FALSE}

suppressMessages(library(mgcv))
suppressMessages(library(caTools))
suppressMessages(library(ggplot2))
suppressMessages(library(MASS))

#dens.pr <- read.csv("data/midwest_pls_density_pr_alb1.6-5.csv") # just with grid cells that have both pls & FIA
#dens.pr <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/midwest_pls_full_density_pr_alb1.6-5.csv") # full set of PLS data
#hist(dens.pr$PLSdensity, breaks = 50)
#dens.pr <- read.csv("data/PLS_full_dens_pr_with_bins.csv")

dens.pr <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/outputs/PLS_full_dens_pr_bins_with_bimodality_for_PC1.csv") 



pls.new <- dens.pr[dens.pr$bimodal == "Unimodal",] # remove all bimodal places for now
pls.bimodal <- dens.pr[dens.pr$bimodal == "Bimodal",]

pls.new <- pls.new[pls.new$PLSdensity > 0.5, ]# remove all zero places
dens.pr <- pls.new
dens.pr <- pls.new

# split into test and training datasets:
Y <- dens.pr$PLSdensity
msk <- sample.split( Y, SplitRatio = 1/4, group = NULL )
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]

#ggplot(dens.pr, aes(x = MAP1910, y = PLSdensity))+geom_point()
#ggplot(dens.pr, aes(x = MAP1910, y = pasttmean, color = PLSdensity))+geom_point()

# basic climate plots of data with only "stable forests/savannas"
PLS.gam1 <-gam(PLSdensity ~ MAP1910, data = train)
PLS.gam1L <-gam(PLSdensity ~  MAP1910, data = train)

pr <- predict(PLS.gam1L, test)
#summary(pr)
#plot(pr, test$PLSdensity)

PLS.gam2 <- gam(PLSdensity ~ s(pasttmean) , data = train)
PLS.gam2L <- gam(PLSdensity ~ pasttmean , data = train)
#summary(PLS.gam2) #explains 15.8% deviance
#plot(PLS.gam2)

PLS.gam3 <- gam(PLSdensity ~ s(pastdeltaP),data = train)
PLS.gam3L <- gam(PLSdensity ~ pastdeltaP,data = train)
#summary(PLS.gam3) #explains 6.07% deviance

PLS.gam4 <- gam(PLSdensity ~ s(deltaT), data = train)
PLS.gam4L <- gam(PLSdensity ~ deltaT, data = train)
#summary(PLS.gam4) #explains 6.07% deviance

PLS.gam5 <- gam(PLSdensity ~ s(awc),data = train)
PLS.gam5L <- gam(PLSdensity ~ awc, data = train)
#summary(PLS.gam5) #explains 12.5% of deviance

PLS.gam6 <- gam(PLSdensity ~ s(sandpct), data = train)
PLS.gam6L <- gam(PLSdensity ~ sandpct, data = train)
#summary(PLS.gam6) #explains 12.5% of deviance



PLS.gam7 <- gam(PLSdensity ~ s(pasttmean) + s(MAP1910) , data = train)
PLS.gam7L <- gam(PLSdensity ~ pasttmean + MAP1910 ,  data = train)
#summary(PLS.gam7) #explains 41% deviance


PLS.gam8 <- gam(PLSdensity ~ s(awc) +s(sandpct), data = train )
PLS.gam8L <- gam(PLSdensity ~ awc + sandpct, data = train )
#summary(PLS.gam8) #explains 28% of deviance

PLS.gam9 <- gam(PLSdensity ~ s(MAP1910) + s(pasttmean) + s(sandpct), data = train)
PLS.gam9L <- gam(PLSdensity ~ MAP1910 + pasttmean + sandpct, data = train)
#summary(PLS.gam9) #explains 39% deviance
#summary(PLS.gam9L)
#plot(PLS.gam6)


PLS.gam10 <- gam(PLSdensity ~ s(MAP1910) +s(pasttmean) + s(awc), data = train)
PLS.gam10L <- gam(PLSdensity ~ MAP1910 + pasttmean + awc, data = train)

#summary(PLS.gam10) #explains 41.3% of deviance
#plot(PLS.gam10)

PLS.gam11 <- gam(PLSdensity ~ s(MAP1910)  +s(pasttmean) +s(sandpct) + s(awc), data = train)
PLS.gam11L <- gam(PLSdensity ~ MAP1910  + pasttmean + sandpct + awc, data = train)

#summary(PLS.gam8) # explains 41% of deviance
PLS.gam12 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), data = train)
PLS.gam12L <- gam(PLSdensity ~ MAP1910  + pasttmean + pastdeltaP, data = train)

PLS.gam13 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), data = train)
PLS.gam13L <- gam(PLSdensity ~ MAP1910  + pasttmean + pastdeltaP, data = train)

PLS.gam13 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(deltaT), data = train)
PLS.gam13L <- gam(PLSdensity ~ MAP1910  + pasttmean + deltaT, data = train)

PLS.gam14 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP)+s(sandpct), data = train)
PLS.gam14L <- gam(PLSdensity ~ MAP1910  + pasttmean + deltaT + pastdeltaP + sandpct, data = train)

PLS.gam15 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP)+s(sandpct)+s(awc), data = train, family = gaussian(link = 'identity'))
PLS.gam15L <- gam(PLSdensity ~ MAP1910  + pasttmean + deltaT + pastdeltaP +sandpct + awc, data = train)

t <- predict(PLS.gam15, test[,c("PLSdensity", "MAP1910", "pasttmean", "deltaT", 'pastdeltaP', 'sandpct', 'awc')])
summary(t)

plot(t, test$PLSdensity)
abline (a = 0, b = 1, col = 'red')
hist(t)
hist(test$PLSdensity)

PLS.gam16 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP), data = train)
PLS.gam16L <- gam(PLSdensity ~ MAP1910  + pasttmean + deltaT + pastdeltaP, data = train)

AIC.df<- AIC(PLS.gam1, PLS.gam2, PLS.gam3, PLS.gam4, PLS.gam5, PLS.gam6, PLS.gam7, PLS.gam8, PLS.gam9,PLS.gam10,PLS.gam11,PLS.gam12,PLS.gam13,PLS.gam14 ,PLS.gam15,PLS.gam16, PLS.gam1L, PLS.gam2L, PLS.gam3L, PLS.gam4L, PLS.gam5L, PLS.gam6L, PLS.gam7L, PLS.gam8L, PLS.gam9L, PLS.gam10L,PLS.gam11L,PLS.gam12L,PLS.gam13L,PLS.gam14L,PLS.gam15L, PLS.gam16L)

#AIC.df$modeltype <- c(rep('smooth', 14), rep('linear', 14))

AIC.df$formula <- c(PLS.gam1$formula, PLS.gam2$formula, PLS.gam3$formula, PLS.gam4$formula, PLS.gam5$formula, PLS.gam6$formula, PLS.gam7$formula, PLS.gam8$formula, PLS.gam9$formula,PLS.gam10$formula,PLS.gam11$formula,PLS.gam12$formula,PLS.gam13$formula,PLS.gam14$formula ,PLS.gam15$formula ,PLS.gam16$formula , PLS.gam1L$formula, PLS.gam2L$formula, PLS.gam3L$formula, PLS.gam4L$formula, PLS.gam5L$formula, PLS.gam6L$formula, PLS.gam7L$formula, PLS.gam8L$formula, PLS.gam9L$formula, PLS.gam10L$formula,PLS.gam11L$formula,PLS.gam12L$formula,PLS.gam13L$formula, PLS.gam14L$formula, PLS.gam15L$formula,PLS.gam16L$formula)

AIC.df<- AIC.df[order(AIC.df$AIC),]
library(knitr)
library(pander)
AIC.df$model <- rownames(AIC.df)

#calculate prediction error:
msqe<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$PLSdensity - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

AIC.df$dev.expl <- 1

#add prediction error & Deviance Explained to the AIC dataframe

for (i in 1: length(AIC.df$model)){
AIC.df[i,'MSPE'] <- msqe(get(AIC.df[i,"model"]), test)
AIC.df[i,"dev.expl"] <- summary(get(AIC.df[i,"model"]))$dev.expl * 100
}

#pander(AIC.df[,c("model", "formula", "df", "AIC", "MSPE", "dev.expl")], split.cells = 30)

print(AIC.df)

```



Table 2: FIA density GAM models
```{r, echo = FALSE, warning = FALSE}

suppressMessages(library(mgcv))
suppressMessages(library(caTools))
suppressMessages(library(ggplot2))

#dens.pr <- read.csv("data/midwest_pls_density_pr_alb1.6-5.csv") # just with grid cells that have both pls & FIA
#dens.pr <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/midwest_pls_full_density_pr_alb1.6-5.csv") # full set of PLS data
#hist(dens.pr$PLSdensity, breaks = 50)
#dens.pr <- read.csv("data/PLS_full_dens_pr_with_bins.csv")

fiadens <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/dens_pr_PLS_FIA_with_cov.csv")

fiadens <- fiadens[fiadens$FIAdensity > 47, ]
#split FIA data into test and trainfing datasets
Y <- fiadens$FIAdensity
msk <- sample.split( Y, SplitRatio = 1/4, group = fiadens$fiaecotype )
#table(Y,msk)

trainf <- fiadens[msk,]
testf <- fiadens[!msk,]


FIA.gam1 <-gam(FIAdensity ~  s(MAP2011), data = trainf)
FIA.gam1L <-gam(FIAdensity ~  MAP2011, data = trainf)


FIA.gam2 <- gam(FIAdensity ~ s(modtmean) , data = trainf)
FIA.gam2L <- gam(FIAdensity ~ modtmean , data = trainf)
#summary(FIA.gam2) #explains 5.6% deviance
#plot(FIA.gam2)

FIA.gam3 <- gam(FIAdensity ~ s(moderndeltaP), data = trainf)
FIA.gam3L <- gam(FIAdensity ~ moderndeltaP, data = trainf)
#summary(FIA.gam3) #explains 6.07% deviance

FIA.gam4 <- gam(FIAdensity ~ s(moddeltaT), data = trainf)
FIA.gam4L <- gam(FIAdensity ~ moddeltaT, data = trainf)
#summary(FIA.gam4) #explains 6.07% deviance

FIA.gam5 <- gam(FIAdensity ~ s(awc),data = trainf)
FIA.gam5L <- gam(FIAdensity ~ awc, data = trainf)
#summary(FIA.gam5) #explains 12.5% of deviance

FIA.gam6 <- gam(FIAdensity ~ s(sandpct), data = trainf)
FIA.gam6L <- gam(FIAdensity ~ sandpct, data = trainf)
#summary(FIA.gam6) #explains 12.5% of deviance



FIA.gam7 <- gam(FIAdensity ~ s(modtmean) + s(MAP2011) , data = trainf, family = quasipoisson())
FIA.gam7L <- gam(FIAdensity ~ modtmean + MAP2011 ,  data = trainf)
#summary(FIA.gam7) #explains 41% deviance
#summary(FIA.gam7L) # explains 19.6%

FIA.gam8 <- gam(FIAdensity ~ s(awc) +s(sandpct), data = trainf )
FIA.gam8L <- gam(FIAdensity ~ awc + sandpct, data = trainf )
#summary(FIA.gam8) #explains 28% of deviance

FIA.gam9 <- gam(FIAdensity ~ s(MAP2011) + s(modtmean) + s(sandpct), data = trainf)
FIA.gam9L <- gam(FIAdensity ~ MAP2011 + modtmean + sandpct, data = trainf)
#summary(FIA.gam9) #explains 39% deviance
#summary(FIA.gam9L)
#plot(FIA.gam6)


FIA.gam10 <- gam(FIAdensity ~ s(MAP2011) +s(modtmean) + s(awc), data = trainf)
FIA.gam10L <- gam(FIAdensity ~ MAP2011 + modtmean + awc, data = trainf)

#summary(FIA.gam10) #explains 41.3% of deviance
#plot(FIA.gam10)

FIA.gam11 <- gam(FIAdensity ~ s(MAP2011)  +s(modtmean) +s(sandpct) + s(awc), data = trainf)
FIA.gam11L <- gam(FIAdensity ~ MAP2011  + modtmean + sandpct + awc, data = trainf)

#summary(FIA.gam8) # explains 41% of deviance
FIA.gam12 <- gam(FIAdensity ~ s(MAP2011)  + s(modtmean) + s(moderndeltaP), data = trainf)
FIA.gam12L <- gam(FIAdensity ~ MAP2011  + modtmean + moderndeltaP, data = trainf)

FIA.gam13 <- gam(FIAdensity ~ s(MAP2011)  + s(modtmean) + s(moderndeltaP), data = trainf)
FIA.gam13L <- gam(FIAdensity ~ MAP2011  + modtmean + moderndeltaP, data = trainf)

FIA.gam13 <- gam(FIAdensity ~ s(MAP2011)  + s(modtmean) + s(moddeltaT), data = trainf)
FIA.gam13L <- gam(FIAdensity ~ MAP2011  + modtmean + moddeltaT, data = trainf)

FIA.gam14 <- gam(FIAdensity ~ s(MAP2011)  + s(modtmean) + s(moddeltaT) + s(moderndeltaP)+s(sandpct), data = trainf)
FIA.gam14L <- gam(FIAdensity ~ MAP2011  + modtmean + moddeltaT + moderndeltaP, data = trainf)

FIA.gam15 <- gam(FIAdensity ~ s(MAP2011)  + s(modtmean) + s(moddeltaT) + s(moderndeltaP)+s(sandpct)+s(awc), data = trainf)
FIA.gam15L <- gam(FIAdensity ~ MAP2011  + modtmean + moddeltaT + moderndeltaP, data = trainf)

FIA.gam16 <- gam(FIAdensity ~ s(MAP2011)  + s(modtmean) + s(moddeltaT) + s(moderndeltaP), data = trainf)
FIA.gam16L <- gam(FIAdensity ~ MAP2011  + modtmean + moddeltaT + moderndeltaP, data = trainf)

AICf.df<- AIC(FIA.gam1, FIA.gam2, FIA.gam3, FIA.gam4, FIA.gam5, FIA.gam6, FIA.gam7, FIA.gam8, FIA.gam9,FIA.gam10,FIA.gam11,FIA.gam12,FIA.gam13,FIA.gam14 ,FIA.gam15,FIA.gam16, FIA.gam1L, FIA.gam2L, FIA.gam3L, FIA.gam4L, FIA.gam5L, FIA.gam6L, FIA.gam7L, FIA.gam8L, FIA.gam9L, FIA.gam10L,FIA.gam11L,FIA.gam12L,FIA.gam13L,FIA.gam14L,FIA.gam15L, FIA.gam16L)

#AIC.df$modeltype <- c(rep('smooth', 14), rep('linear', 14))

AICf.df$formula <- c(FIA.gam1$formula, FIA.gam2$formula, FIA.gam3$formula, FIA.gam4$formula, FIA.gam5$formula, FIA.gam6$formula, FIA.gam7$formula, FIA.gam8$formula, FIA.gam9$formula,FIA.gam10$formula,FIA.gam11$formula,FIA.gam12$formula,FIA.gam13$formula,FIA.gam14$formula ,FIA.gam15$formula , FIA.gam16L$formula, FIA.gam1L$formula, FIA.gam2L$formula, FIA.gam3L$formula, FIA.gam4L$formula, FIA.gam5L$formula, FIA.gam6L$formula, FIA.gam7L$formula, FIA.gam8L$formula, FIA.gam9L$formula, FIA.gam10L$formula,FIA.gam11L$formula,FIA.gam12L$formula,FIA.gam13L$formula, FIA.gam14L$formula, FIA.gam15L$formula, FIA.gam16L$formula )

AICf.df<- AICf.df[order(AICf.df$AIC),]
library(knitr)
library(pander)
AICf.df$model <- as.character(rownames(AICf.df))

#calculate prediction error:
msqe.f<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$FIAdensity - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

AICf.df$MSPE <- 1
AICf.df$dev.expl <- 1

#add prediction error of AIC dataframe

for (i in 1: length(AICf.df$model)){
AICf.df[i,'MSPE'] <- msqe.f(get(AICf.df[i,"model"]), testf)
AICf.df[i,"dev.expl"] <- summary(get(AICf.df[i,"model"]))$dev.expl * 100
}

print(AICf.df)
#print(AICf.df[,c("model", "formula", "df", "AIC", "MSPE")], split.cells = 30)

```


###Predicting Tree density (GAMs)

The model with the lowest AIC value is represented by the formula:
PLSdensity ~ s(MAP) + s(MAT) + s(TempCV) + s(PrecipSI) + s(% sand) + s(awc)

Addtionally, for the FIA dataset the model with the lowest AIC also includes MAP, MAT, TempCV, PrecipSI, % sand, and awc. However, the model fits for the modern landscape are substantially lower.

# Supplemental PLS density model fit figures:
```{r, echo = FALSE, warning = FALSE}
suppressMessages(library(maps))
suppressMessages(library(sp))
suppressMessages(library(rgeos))
suppressMessages(library(visreg))
suppressMessages(library(grid))
all_states <- map_data("state")
states <- subset(all_states, region %in% c(  'minnesota','wisconsin','michigan',"illinois",  'indiana') )
coordinates(states)<-~long+lat
class(states)
proj4string(states) <-CRS("+proj=longlat +datum=NAD83")
mapdata<-spTransform(states, CRS('+init=epsg:3175'))
mapdata <- data.frame(mapdata)
cbpalette <- c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837")
#map out 


# plot the predicted response fields to these variables
# make a function to extracted predictions from a model
get.preds <- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")

testdata$ypred <- ypred

testdata
}

# for the PLS:
predicteddf <- get.preds(PLS.gam16, test)
#summary(predicted$ypred)

# for the PLS bimodal only places
predictedbm <- get.preds(PLS.gam16, pls.bimodal)

#summary(predictedbm$ypred)


msqe<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$PLSdensity - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

msqe(PLS.gam15L, test)
msqe(PLS.gam15L, pls.bimodal)



# predictions for FIA
predictedf <- get.preds(FIA.gam15, testf)
summary(predictedf$ypred)


####################################
# Plotting predicted vs. observed ##
####################################

# Define function to plot predicted vs. observed:
pvsobs <- function(preds, obs, colorby, model ){
# plot predicted vs. observed for PLS
ggplot(preds, aes(preds[,obs], ypred, color = preds[,colorby])) +geom_point() + theme_bw()+geom_abline(intercept = 0, slope = 1, color = 'red', size = 2) + #ylim (-10, 600)+xlim(-10,600) +
  ggtitle(paste('Predicted vs. Observed', model)) + ylab('Predicted tree density') + xlab('Observed tree density')
}

# plot predicted vs. observed for PLS model 15
pvsobs(preds = predicted, obs = 'PLSdensity', colorby = "PC1", model = "PLS density")

# plot predicted vs. observed for PLS model 15
pvsobs(preds = predictedbm, obs = 'PLSdensity', colorby = "PC1", model = "PLS density Bimodal only places")


# plot FIA predicted vs. observed model 15
pvsobs(preds = predictedf, obs = 'FIAdensity', colorby = "PC1", model = "FIA density")


```
The predicted vs. observed plot shows overestimation of PLS tree density in Low density areas and underestimation of PLS tree density in High density areas. Below we map out the predictions and prediction errors in space. Model fit has improved for the stable portions of the PLS landscape, and does an Okay job predicting PLS tree density. Note that the predictions here are overall much higher than the observations for FIA tree denisty. 


 # Map out predictions in space:
```{r, echo = FALSE, warning = FALSE}

# Creat a function to plot the predicted tree denisty in the map
map.preds <- function(preds, model){
ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=preds, aes(x=x, y=y, fill = ypred))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title=paste("Predicted", model)) + 
  scale_fill_gradientn(colours = c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837"), limits = c(0,700), name ="Tree \n Density \n (trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw()
  
}

map.preds(preds = predicted, model = "PLS denisty")
map.preds(preds = predictedbm, model = "PLS denisty bimodal only")

map.preds(preds = predictedf, model = "FIA denisty")


```

#Mapping out predicted - observed for each grid cell in the test dataset. 

```{r, echo = FALSE,  warning = FALSE}

suppressMessages(library(RColorBrewer))

# function to calculate discrete bins of model error
diserror.map<- function (preds, obs, model){
# calculate preds - observed
preds$podiff <- preds[,'ypred'] - preds[,obs]

Sd = rep(0,length(preds$podiff))
  Sd[which(preds$podiff>0 & preds$podiff<=10)] = 1
  Sd[which(preds$podiff>10 & preds$podiff<=50)] = 2
  
  Sd[which(preds$podiff>50 & preds$podiff<=100)] = 3
  Sd[which(preds$podiff>100) ] = 4
  Sd[which(preds$podiff== 0)] = 0
   Sd[which(preds$podiff>=-10 & preds$podiff<0)] = -1
  Sd[which(preds$podiff>-50 & preds$podiff<=-10)] = -2
  
  Sd[which(preds$podiff> -100 & preds$podiff<=-50)] = -3
  Sd[which(preds$podiff< -100) ] = -4
  Sd = factor(Sd,levels=-4:4)
  levels(Sd) = c(">-100","(-100,-50]","(-50, -10]","(-10,0]",'0','(0,10]','(10,50]','(50, 100]','(100,200]')
  
  preds$errordiscrete <- Sd
  
 gs.pal <- colorRampPalette(brewer.pal(11,"PRGn"))


# map out preds - observed using discrete scale
ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=preds, aes(x=x, y=y, fill = errordiscrete))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title=paste("Predicted - Obs", model)) +scale_fill_manual(values=gs.pal(9),drop=FALSE) +
  coord_equal()+theme_bw()
}

diserror.map ( preds = predicted, obs = "PLSdensity", model = "PLS density")

diserror.map ( preds = predictedbm, obs = "PLSdensity", model = "PLS bimodal places")


diserror.map ( preds = predictedf, obs = "FIAdensity", model = "FIA density")


```



# Plot the predicted - observed by veg class
```{r, echo = FALSE,  warning = FALSE}
suppressMessages(library(modes))
suppressMessages(library(gridExtra))

class.plots<- function(preds, obs, class){
preds$podiff <- preds[,'ypred'] - preds[,obs]

a <- ggplot(preds, aes(x = preds[,class], y = podiff))+geom_boxplot()+xlab("Predicted - Observed for different Bimodal regions")+theme_bw()

b <- ggplot(preds, aes(x = podiff)) + geom_vline( aes(xintercept=0), colour="red") +geom_histogram()+facet_grid(preds[,class]~., scales = 'free') + xlab("Predicted - Observed for different Bimodal regions") + theme_bw()
grid.arrange(a,b, ncol = 1, nrow = 2)
}

class.plots(preds = predicted, obs = "PLSdensity", class = 'classification')
class.plots(preds = predictedbm, obs = "PLSdensity", class = 'classification')

class.plots(preds = predictedf, obs = "FIAdensity", class = 'fiaecotype')


```

# Plot predicted - obs against density:

```{r, echo = FALSE,  warning = FALSE}

plot.po.dens <- function(preds, obs, model){
preds$podiff <- preds[,'ypred'] - preds[,obs]
Sd = rep(0,length(preds$podiff))
  Sd[which(preds$podiff>0 & preds$podiff<=10)] = 1
  Sd[which(preds$podiff>10 & preds$podiff<=50)] = 2
  
  Sd[which(preds$podiff>50 & preds$podiff<=100)] = 3
  Sd[which(preds$podiff>100) ] = 4
  Sd[which(preds$podiff== 0)] = 0
   Sd[which(preds$podiff>=-10 & preds$podiff<0)] = -1
  Sd[which(preds$podiff>-50 & preds$podiff<=-10)] = -2
  
  Sd[which(preds$podiff> -100 & preds$podiff<=-50)] = -3
  Sd[which(preds$podiff< -100) ] = -4
  Sd = factor(Sd,levels=-4:4)
  levels(Sd) = c(">-100","(-100,-50]","(-50, -10]","(-10,0]",'0','(0,10]','(10,50]','(50, 100]','(100,200]')
  
  preds$errordiscrete <- Sd
  
 gs.pal <- colorRampPalette(brewer.pal(11,"PRGn"))

ggplot() + geom_point(data = preds, aes(x= preds[,obs], y = podiff, color = errordiscrete)) +scale_color_manual(values=gs.pal(9),name = "Pred-Obs",drop=FALSE)+ theme_bw() + xlab("Tree density")+ ylab("Predicted - Observed") + ggtitle(paste("Predicted - obs. vs.", model))
}

plot.po.dens(predicted, "PLSdensity", model = "PLS density")
plot.po.dens(predictedbm, "PLSdensity", model = "PLS density bimodal cells")

plot.po.dens(predictedf, "FIAdensity", model = "FIA density")

```
PLS model trained on the stable places results in high overpredictions for low tree denisty areas and moderate underprediction for tree density in high density grid cells. 

FIA models overpredict over the places that have low tree denisty. I think that if we remove the low denisty places, we might be able to better predict. 


## Predicting Forest vs. Savanna (not density)

The above models are predicting density (continious variable) from continous envrionmental and climate covariates. However, we can also use the savanna/forest density classificaitons as our y variable and  predict the probability a grid cell is forest (ecocode = 1, PLS density > 47 trees/ha) and savannna (ecocode = 0, PLSdensity < 47 trees/ha & >0.5 trees/ha) from continous environmental and climate covariates. 


This method has the benefit of predicting the probability of forest (or the probability of savanna) given certain environmental conditions. For this analysis, we exclude prairie sites

# Modeling p(forest):
```{r echo = FALSE, warning = FALSE}
dens.pr <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/midwest_pls_full_density_pr_alb1.6-5.csv") 
dens.pr <- read.csv("outputs/PLS_full_dens_pr_bins_with_bimodality_for_PC1.csv") 


fiadens <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/dens_pr_PLS_FIA_with_cov.csv")

future <- fiadens[,c('x','y','FIAdensity', 'MAP2011', 'moderndeltaP', "modtmean", 'moddeltaT', 'sandpct','awc','ksat', 'fiaecotype')]

# rename future variables to match pls
colnames(future) <- c('x','y','PLSdensity', 'MAP1910', 'pastdeltaP', 'pasttmean', 'deltaT', "sandpct", "awc", "ksat",'fiaecotype')

# dummyvariables for logistic regression:
dens.pr$ecocode <- 0
dens.pr[dens.pr$ecotype %in% 'Forest', ]$ecocode <- 1
dens.pr<- dens.pr[!dens.pr$ecotype %in% 'prairie',]

future$ecocode <- 0
future[future$fiaecotype %in% 'Forest', ]$ecocode <- 1
future<- future[!future$fiaecotype %in% 'prairie',]


#split trainfing and testing
Y <- dens.pr$ecotype
msk <- sample.split( Y, SplitRatio = 3/4, group = NULL)
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]


#plot(dens.pr$sandpct, dens.pr$ecotype)


PLS.lgr1 <-gam(ecocode ~  s(MAP1910), family = 'binomial',data = train)
PLS.lgr1L <-gam(ecocode ~  MAP1910, family = 'binomial',data = train)


PLS.lgr2 <- gam(ecocode ~ s(pasttmean) , family = 'binomial',data = train)
PLS.lgr2L <- gam(ecocode ~ pasttmean , family = 'binomial',data = train)
#summary(PLS.lgr2) #explains 15.8% deviance
#plot(PLS.lgr2)

PLS.lgr3 <- gam(ecocode ~ s(pastdeltaP), family = 'binomial',data = train)
PLS.lgr3L <- gam(ecocode ~ pastdeltaP, family = 'binomial',data = train)
#summary(PLS.lgr3) #explains 6.07% deviance

PLS.lgr4 <- gam(ecocode ~ s(deltaT), family = 'binomial',data = train)
PLS.lgr4L <- gam(ecocode ~ deltaT, family = 'binomial',data = train)
#summary(PLS.lgr4) #explains 6.07% deviance

PLS.lgr5 <- gam(ecocode ~ s(awc), family = 'binomial',data = train)
PLS.lgr5L <- gam(ecocode ~ awc, family = 'binomial',data = train)
#summary(PLS.lgr5) #explains 12.5% of deviance

PLS.lgr6 <- gam(ecocode ~ s(sandpct), family = 'binomial',data = train)
PLS.lgr6L <- gam(ecocode ~ sandpct, family = 'binomial',data = train)
#summary(PLS.lgr6) #explains 12.5% of deviance



PLS.lgr7 <- gam(ecocode ~ s(pasttmean) + s(MAP1910) ,  family = 'binomial',data = train)
PLS.lgr7L <- gam(ecocode ~ pasttmean + MAP1910 ,  family = 'binomial',data = train)
#summary(PLS.lgr7) #explains 41% deviance
#summary(PLS.lgr7L) # explains 19.6%

PLS.lgr8 <- gam(ecocode ~ s(awc) +s(sandpct), family = 'binomial',data = train )
PLS.lgr8L <- gam(ecocode ~ awc + sandpct, family = 'binomial',data = train )
#summary(PLS.lgr8) #explains 28% of deviance

PLS.lgr9 <- gam(ecocode ~ s(MAP1910) + s(pasttmean) + s(sandpct), family = 'binomial',data = train)
PLS.lgr9L <- gam(ecocode ~ MAP1910 + pasttmean + sandpct, family = 'binomial',data = train)
#summary(PLS.lgr9) #explains 39% deviance
#summary(PLS.lgr9L)
#plot(PLS.lgr6)


PLS.lgr10 <- gam(ecocode ~ s(MAP1910) +s(pasttmean) + s(awc), family = 'binomial',data = train)
PLS.lgr10L <- gam(ecocode ~ MAP1910 + pasttmean + awc, family = 'binomial',data = train)

#summary(PLS.lgr10) #explains 41.3% of deviance
#plot(PLS.lgr10)

PLS.lgr11 <- gam(ecocode ~ s(MAP1910)  +s(pasttmean) +s(sandpct) + s(awc), family = 'binomial',data = train)
PLS.lgr11L <- gam(ecocode ~ MAP1910  + pasttmean + sandpct + awc, family = 'binomial',data = train)

#summary(PLS.lgr8) # explains 41% of deviance
PLS.lgr12 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP),family = 'binomial', data = train)
PLS.lgr12L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = train)

PLS.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), family = 'binomial',data = train)
PLS.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = train)

#PLS.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT), family = 'binomial',data = train)
#PLS.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT, family = 'binomial',data = train)

PLS.lgr14 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP)+s(sandpct)+s(awc), family = 'binomial',data = train)
PLS.lgr14L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT + pastdeltaP, family = 'binomial',data = train)

AIC2.df<- AIC(PLS.lgr1, PLS.lgr2, PLS.lgr3, PLS.lgr4, PLS.lgr5, PLS.lgr6, PLS.lgr7, PLS.lgr8, PLS.lgr9,PLS.lgr10,PLS.lgr11,PLS.lgr12,PLS.lgr13,PLS.lgr14 , PLS.lgr1L, PLS.lgr2L, PLS.lgr3L, PLS.lgr4L, PLS.lgr5L, PLS.lgr6L, PLS.lgr7L, PLS.lgr8L, PLS.lgr9L, PLS.lgr10L,PLS.lgr11L,PLS.lgr12L,PLS.lgr13L,PLS.lgr14L)




AIC2.df$modeltype <- c(rep('smooth', 14), rep('linear', 14))

AIC2.df$formula <- c(PLS.lgr1$formula, PLS.lgr2$formula, PLS.lgr3$formula, PLS.lgr4$formula, PLS.lgr5$formula, PLS.lgr6$formula, PLS.lgr7$formula, PLS.lgr8$formula, PLS.lgr9$formula,PLS.lgr10$formula,PLS.lgr11$formula,PLS.lgr12$formula,PLS.lgr13$formula,PLS.lgr14$formula , PLS.lgr1L$formula, PLS.lgr2L$formula, PLS.lgr3L$formula, PLS.lgr4L$formula, PLS.lgr5L$formula, PLS.lgr6L$formula, PLS.lgr7L$formula, PLS.lgr8L$formula, PLS.lgr9L$formula, PLS.lgr10L$formula,PLS.lgr11L$formula,PLS.lgr12L$formula,PLS.lgr13L$formula, PLS.lgr14L$formula )

AIC2.df<- AIC2.df[order(AIC2.df$AIC),]
library(knitr)
library(pander)
AIC2.df$model <- rownames(AIC2.df)

#calculate prediction error:
msqe.code<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$ecocode - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

AIC2.df$MSPE <- 1

#add prediction error ot AIC dataframe

for (i in 1: length(AIC2.df$model)){
AIC2.df[i,'MSPE'] <- msqe.code(get(AIC2.df[i,"model"]), test)
}
pander(AIC2.df[,c("model","modeltype", "formula", "df", "AIC", "MSPE")], split.cells = 30)


full <- dens.pr
#full <- test
logsample <- predict(PLS.lgr14, full, type="response")
full$ypred <- as.numeric(logsample)
#summary(logsample)
#hist(test$ypred)

#ggplot(full, aes(x, y, color = ypred)) + geom_point()
#ggplot(test, aes(x, y, color = ecocode)) + geom_point()+coord_equal()

ggplot(full, aes(ypred, PLSdensity))+geom_point()

#ggplot(test, aes (ypred, MAP1910))+geom_point()



# create discrete probability cuts
label.breaks <- function(beg, end, splitby){
  labels.test <- data.frame(first = seq(beg, end, by = splitby), second = seq((beg + splitby), (end + splitby), by = splitby))
  labels.test <- paste (labels.test$first, '-' , labels.test$second)
  labels.test
}


full$ypreddiscrete <- cut(full$ypred, breaks = seq(0,1, by = 0.2), labels = label.breaks(0,0.8, 0.2))



cbpalette <- c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837")

full$ypreddiscrete <- as.character(full$ypreddiscrete)
#ggplot(full, aes(x, y, color = ypreddiscrete)) + geom_point()


fullnona <- full[!is.na(full$ypreddiscrete),]
# plot the discrete probability of forest 
p.forest <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=fullnona, aes(x=x, y=y, fill = ypreddiscrete))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="Climate Predicted Prob(forest)")+ scale_fill_manual(values= cbpalette, labels=c("0 - 0.2","0.2 - 0.4","0.4 - 0.6","0.6 - 0.8","0.8 - 1")) +
  coord_equal()+theme_bw()+ theme()+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1)) + labs(fill = "p (forest)")+ annotate("text", x=-90000, y=1486000,label= "B", size = 5)+ggtitle("")

p.forest

# plot PLS forests
pls <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=full, aes(x=x, y=y, fill = ecotype))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="PLS classification")+ scale_fill_manual(values= c("#006837", "#c2e699"))+ coord_equal()+theme_bw()+theme(axis.text = element_blank(), axis.ticks=element_blank(),legend.key.size = unit(0.6,'lines'), legend.position = c(0.205, 0.125),legend.background = element_rect(fill=alpha('transparent', 0.4)),
panel.grid.major = element_blank(),panel.border = element_rect(colour = "black", fill=NA, size=1), legend.title = element_blank())+ annotate("text", x=-90000, y=1486000,label= "A", size = 5)+ggtitle("")

png(width = 8, height = 4, units = 'in', res = 300, filename = 'outputs/v1.6-5/full/logistic_pred_prob_testdata.png')
grid.arrange(pls, p.forest, nrow = 1, ncol=2)
dev.off()

png(width = 8, height = 4, units = 'in', res = 300, filename = 'outputs/paper_figs/logistic_pred_prob_testdata.png')
grid.arrange(pls, p.forest, nrow = 1, ncol=2)
dev.off()

ggplot(full, aes(x = PC1, y = ypred))+geom_point()

# use the pls model to model the modern landscape:
fia <- future
logsample <- predict(PLS.lgr14, fia, type="response")
fia$ypred <- as.numeric(logsample)
summary(logsample)
hist(fia$ypred)

ggplot(fia, aes(x, y, color = ypred)) + geom_point()
ggplot(fia, aes(x, y, color = ecocode)) + geom_point()+coord_equal()

ggplot(fia, aes(ypred, PLSdensity))+geom_point()

#ggplot(test, aes (ypred, MAP1910))+geom_point()



# create discrete probability cuts
label.breaks <- function(beg, end, splitby){
  labels.test <- data.frame(first = seq(beg, end, by = splitby), second = seq((beg + splitby), (end + splitby), by = splitby))
  labels.test <- paste (labels.test$first, '-' , labels.test$second)
  labels.test
}


fia$ypreddiscrete <- cut(fia$ypred, breaks = seq(0,1, by = 0.2), labels = label.breaks(0,0.8, 0.2))



cbpalette <- c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837")

fia$ypreddiscrete <- as.character(fia$ypreddiscrete)

# plot predictions for modern forests based on pls-climate relationships: 
# it actually predicts a contraction of the forests!
f.forest <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=fia, aes(x=x, y=y, fill = ypreddiscrete))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="Climate Predicted Prob(forest)")+ scale_fill_manual(values= cbpalette) +
  coord_equal()+theme_bw()+ theme()


mod <- ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=fia, aes(x=x, y=y, fill = fiaecotype))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="FIA classification")+ scale_fill_manual(values= c("#006837", "#c2e699"))+ coord_equal()+theme_bw()

png(width = 8, height = 4, units = 'in', res = 300, filename = 'outputs/v1.6-5/full/logistic_pred_prob_FIA_from_PLS_model.png')
grid.arrange(mod, f.forest, nrow = 1, ncol=2)
dev.off()

```

# modeling p(savanna)
```{r echo = FALSE, warning = FALSE}
dens.pr <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/midwest_pls_full_density_pr_alb1.6-5.csv") 

# dummyvariables for logistic regression:
dens.pr$ecocode <- 1
dens.pr[dens.pr$ecotype %in% 'Forest', ]$ecocode <- 0
dens.pr<- dens.pr[!dens.pr$ecotype %in% 'prairie',]

#split trainfing and testing
Y <- dens.pr$ecotype
msk <- sample.split( Y, SplitRatio = 3/4, group = NULL)
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]


#plot(dens.pr$sandpct, dens.pr$ecotype)


PLS.lgr1 <-gam(ecocode ~  s(MAP1910), family = 'binomial',data = train)
PLS.lgr1L <-gam(ecocode ~  MAP1910, family = 'binomial',data = train)


PLS.lgr2 <- gam(ecocode ~ s(pasttmean) , family = 'binomial',data = train)
PLS.lgr2L <- gam(ecocode ~ pasttmean , family = 'binomial',data = train)
#summary(PLS.lgr2) #explains 15.8% deviance
#plot(PLS.lgr2)

PLS.lgr3 <- gam(ecocode ~ s(pastdeltaP), family = 'binomial',data = train)
PLS.lgr3L <- gam(ecocode ~ pastdeltaP, family = 'binomial',data = train)
#summary(PLS.lgr3) #explains 6.07% deviance

PLS.lgr4 <- gam(ecocode ~ s(deltaT), family = 'binomial',data = train)
PLS.lgr4L <- gam(ecocode ~ deltaT, family = 'binomial',data = train)
#summary(PLS.lgr4) #explains 6.07% deviance

PLS.lgr5 <- gam(ecocode ~ s(awc), family = 'binomial',data = train)
PLS.lgr5L <- gam(ecocode ~ awc, family = 'binomial',data = train)
#summary(PLS.lgr5) #explains 12.5% of deviance

PLS.lgr6 <- gam(ecocode ~ s(sandpct), family = 'binomial',data = train)
PLS.lgr6L <- gam(ecocode ~ sandpct, family = 'binomial',data = train)
#summary(PLS.lgr6) #explains 12.5% of deviance



PLS.lgr7 <- gam(ecocode ~ s(pasttmean) + s(MAP1910) ,  family = 'binomial',data = train)
PLS.lgr7L <- gam(ecocode ~ pasttmean + MAP1910 ,  family = 'binomial',data = train)
#summary(PLS.lgr7) #explains 41% deviance
#summary(PLS.lgr7L) # explains 19.6%

PLS.lgr8 <- gam(ecocode ~ s(awc) +s(sandpct), family = 'binomial',data = train )
PLS.lgr8L <- gam(ecocode ~ awc + sandpct, family = 'binomial',data = train )
#summary(PLS.lgr8) #explains 28% of deviance

PLS.lgr9 <- gam(ecocode ~ s(MAP1910) + s(pasttmean) + s(sandpct), family = 'binomial',data = train)
PLS.lgr9L <- gam(ecocode ~ MAP1910 + pasttmean + sandpct, family = 'binomial',data = train)
#summary(PLS.lgr9) #explains 39% deviance
#summary(PLS.lgr9L)
#plot(PLS.lgr6)


PLS.lgr10 <- gam(ecocode ~ s(MAP1910) +s(pasttmean) + s(awc), family = 'binomial',data = train)
PLS.lgr10L <- gam(ecocode ~ MAP1910 + pasttmean + awc, family = 'binomial',data = train)

#summary(PLS.lgr10) #explains 41.3% of deviance
#plot(PLS.lgr10)

PLS.lgr11 <- gam(ecocode ~ s(MAP1910)  +s(pasttmean) +s(sandpct) + s(awc), family = 'binomial',data = train)
PLS.lgr11L <- gam(ecocode ~ MAP1910  + pasttmean + sandpct + awc, family = 'binomial',data = train)

#summary(PLS.lgr8) # explains 41% of deviance
PLS.lgr12 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP),family = 'binomial', data = train)
PLS.lgr12L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = train)

PLS.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), family = 'binomial',data = train)
PLS.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = train)

#PLS.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT), family = 'binomial',data = train)
#PLS.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT, family = 'binomial',data = train)

PLS.lgr14 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP)+s(sandpct)+s(awc), family = 'binomial',data = train)
PLS.lgr14L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT + pastdeltaP, family = 'binomial',data = train)

AIC2.df<- AIC(PLS.lgr1, PLS.lgr2, PLS.lgr3, PLS.lgr4, PLS.lgr5, PLS.lgr6, PLS.lgr7, PLS.lgr8, PLS.lgr9,PLS.lgr10,PLS.lgr11,PLS.lgr12,PLS.lgr13,PLS.lgr14 , PLS.lgr1L, PLS.lgr2L, PLS.lgr3L, PLS.lgr4L, PLS.lgr5L, PLS.lgr6L, PLS.lgr7L, PLS.lgr8L, PLS.lgr9L, PLS.lgr10L,PLS.lgr11L,PLS.lgr12L,PLS.lgr13L,PLS.lgr14L)




AIC2.df$modeltype <- c(rep('smooth', 14), rep('linear', 14))

AIC2.df$formula <- c(PLS.lgr1$formula, PLS.lgr2$formula, PLS.lgr3$formula, PLS.lgr4$formula, PLS.lgr5$formula, PLS.lgr6$formula, PLS.lgr7$formula, PLS.lgr8$formula, PLS.lgr9$formula,PLS.lgr10$formula,PLS.lgr11$formula,PLS.lgr12$formula,PLS.lgr13$formula,PLS.lgr14$formula , PLS.lgr1L$formula, PLS.lgr2L$formula, PLS.lgr3L$formula, PLS.lgr4L$formula, PLS.lgr5L$formula, PLS.lgr6L$formula, PLS.lgr7L$formula, PLS.lgr8L$formula, PLS.lgr9L$formula, PLS.lgr10L$formula,PLS.lgr11L$formula,PLS.lgr12L$formula,PLS.lgr13L$formula, PLS.lgr14L$formula )

AIC2.df<- AIC2.df[order(AIC2.df$AIC),]
library(knitr)
library(pander)
AIC2.df$model <- rownames(AIC2.df)

#calculate prediction error:
msqe.code<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$ecocode - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

AIC2.df$MSPE <- 1

#add prediction error ot AIC dataframe

for (i in 1: length(AIC2.df$model)){
AIC2.df[i,'MSPE'] <- msqe.code(get(AIC2.df[i,"model"]), test)
}
pander(AIC2.df[,c("model","modeltype", "formula", "df", "AIC", "MSPE")], split.cells = 30)

logsample <- predict(PLS.lgr14, test, type="response")
test$ypred <- logsample
summary(logsample)
hist(test$ypred)

ggplot(test, aes(MAP1910, ypred, color = ypred)) + geom_point()
ggplot(test, aes(x, y, color = ypred)) + geom_point()


```
Looks like model number 14 with just Mean Annual Precipitation has lowest AIC for the logistic/binomial model. 
Lets map out the probability of forest based on model with the lowest AIC value:

forest type ~ s(MAP1910)+ s(pasttmean) + s(deltaT) +   s(pastdeltaP)

The smooth predictors in this model are the same as the smooth predictors in the denisty model

# savanna forest model for FIA:
```{r echo = FALSE, warning = FALSE}

# dummyvariables for logistic regression:
fiadens$ecocode <- 0
fiadens[fiadens$ecotype %in% 'Forest', ]$ecocode <- 1
#fiadens<- fiadens[!fiadens$ecotype %in% 'prairie',]

#split trainffing and testfing
Y <- fiadens$ecotype
msk <- sample.split( Y, SplitRatio = 1/4, group = NULL )
#table(Y,msk)

trainf <- fiadens[msk,]
testf <- fiadens[!msk,]


#plot(fiadens$sandpct, fiadens$ecotype)


FIA.lgr1 <-gam(ecocode ~  s(MAP1910), family = 'binomial',data = trainf)
FIA.lgr1L <-gam(ecocode ~  MAP1910, family = 'binomial',data = trainf)


FIA.lgr2 <- gam(ecocode ~ s(pasttmean) , family = 'binomial',data = trainf)
FIA.lgr2L <- gam(ecocode ~ pasttmean , family = 'binomial',data = trainf)
#summary(FIA.lgr2) #explains 15.8% deviance
#plot(FIA.lgr2)

FIA.lgr3 <- gam(ecocode ~ s(pastdeltaP), family = 'binomial',data = trainf)
FIA.lgr3L <- gam(ecocode ~ pastdeltaP, family = 'binomial',data = trainf)
#summary(FIA.lgr3) #explains 6.07% deviance

FIA.lgr4 <- gam(ecocode ~ s(deltaT), family = 'binomial',data = trainf)
FIA.lgr4L <- gam(ecocode ~ deltaT, family = 'binomial',data = trainf)
#summary(FIA.lgr4) #explains 6.07% deviance

FIA.lgr5 <- gam(ecocode ~ s(awc), family = 'binomial',data = trainf)
FIA.lgr5L <- gam(ecocode ~ awc, family = 'binomial',data = trainf)
#summary(FIA.lgr5) #explains 12.5% of deviance

FIA.lgr6 <- gam(ecocode ~ s(sandpct), family = 'binomial',data = trainf)
FIA.lgr6L <- gam(ecocode ~ sandpct, family = 'binomial',data = trainf)
#summary(FIA.lgr6) #explains 12.5% of deviance



FIA.lgr7 <- gam(ecocode ~ s(pasttmean) + s(MAP1910) ,  family = 'binomial',data = trainf)
FIA.lgr7L <- gam(ecocode ~ pasttmean + MAP1910 ,  family = 'binomial',data = trainf)
#summary(FIA.lgr7) #explains 41% deviance
#summary(FIA.lgr7L) # explains 19.6%

FIA.lgr8 <- gam(ecocode ~ s(awc) +s(sandpct), family = 'binomial',data = trainf )
FIA.lgr8L <- gam(ecocode ~ awc + sandpct, family = 'binomial',data = trainf )
#summary(FIA.lgr8) #explains 28% of deviance

FIA.lgr9 <- gam(ecocode ~ s(MAP1910) + s(pasttmean) + s(sandpct), family = 'binomial',data = trainf)
FIA.lgr9L <- gam(ecocode ~ MAP1910 + pasttmean + sandpct, family = 'binomial',data = trainf)
#summary(FIA.lgr9) #explains 39% deviance
#summary(FIA.lgr9L)
#plot(FIA.lgr6)


FIA.lgr10 <- gam(ecocode ~ s(MAP1910) +s(pasttmean) + s(awc), family = 'binomial',data = trainf)
FIA.lgr10L <- gam(ecocode ~ MAP1910 + pasttmean + awc, family = 'binomial',data = trainf)

#summary(FIA.lgr10) #explains 41.3% of deviance
#plot(FIA.lgr10)

FIA.lgr11 <- gam(ecocode ~ s(MAP1910)  +s(pasttmean) +s(sandpct) + s(awc), family = 'binomial',data = trainf)
FIA.lgr11L <- gam(ecocode ~ MAP1910  + pasttmean + sandpct + awc, family = 'binomial',data = trainf)

#summary(FIA.lgr8) # explains 41% of deviance
FIA.lgr12 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP),family = 'binomial', data = trainf)
FIA.lgr12L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = trainf)

FIA.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), family = 'binomial',data = trainf)
FIA.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = trainf)

#FIA.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT), family = 'binomial',data = trainf)
#FIA.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT, family = 'binomial',data = trainf)

FIA.lgr14 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP)+s(sandpct)+s(awc), family = 'binomial',data = trainf)
FIA.lgr14L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT + pastdeltaP, family = 'binomial',data = trainf)

AIC2.df<- AIC(FIA.lgr1, FIA.lgr2, FIA.lgr3, FIA.lgr4, FIA.lgr5, FIA.lgr6, FIA.lgr7, FIA.lgr8, FIA.lgr9,FIA.lgr10,FIA.lgr11,FIA.lgr12,FIA.lgr13,FIA.lgr14 , FIA.lgr1L, FIA.lgr2L, FIA.lgr3L, FIA.lgr4L, FIA.lgr5L, FIA.lgr6L, FIA.lgr7L, FIA.lgr8L, FIA.lgr9L, FIA.lgr10L,FIA.lgr11L,FIA.lgr12L,FIA.lgr13L,FIA.lgr14L)




AIC2.df$modeltype <- c(rep('smooth', 14), rep('linear', 14))

AIC2.df$formula <- c(FIA.lgr1$formula, FIA.lgr2$formula, FIA.lgr3$formula, FIA.lgr4$formula, FIA.lgr5$formula, FIA.lgr6$formula, FIA.lgr7$formula, FIA.lgr8$formula, FIA.lgr9$formula,FIA.lgr10$formula,FIA.lgr11$formula,FIA.lgr12$formula,FIA.lgr13$formula,FIA.lgr14$formula , FIA.lgr1L$formula, FIA.lgr2L$formula, FIA.lgr3L$formula, FIA.lgr4L$formula, FIA.lgr5L$formula, FIA.lgr6L$formula, FIA.lgr7L$formula, FIA.lgr8L$formula, FIA.lgr9L$formula, FIA.lgr10L$formula,FIA.lgr11L$formula,FIA.lgr12L$formula,FIA.lgr13L$formula, FIA.lgr14L$formula )

AIC2.df<- AIC2.df[order(AIC2.df$AIC),]
library(knitr)
library(pander)
AIC2.df$model <- rownames(AIC2.df)

#calculate prediction error:
msqe.code<- function(model, testfdata){
ypred <- predict(model, newdata = testfdata, type="response")
testfdata$ypred <- ypred

predicted<- testfdata
  
predicted$sqerr <- (predicted$ecocode - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

AIC2.df$MSPE <- 1

#add prediction error ot AIC dataframe

for (i in 1: length(AIC2.df$model)){
AIC2.df[i,'MSPE'] <- msqe.code(get(AIC2.df[i,"model"]), test)
}
pander(AIC2.df[,c("model","modeltype", "formula", "df", "AIC", "MSPE")], split.cells = 30)


```
