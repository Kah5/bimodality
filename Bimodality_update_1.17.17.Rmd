---
title: "Update on Bimodality Figures & Analyses"
author: "Kelly Heilman"
date: "February 14th, 2017"
bibliography: bimodality.bib
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Paper outline:


1. Intro:
  * Biome theory overview
  * Savanna-grassland-forest alternative stable states and fire dominated regions defy biome theory & make it difficult to project into the future
    + Bimodal distribution in tree cover/tree density that is not deterministically predicted by climate or environmental factors is a hallmark of alternative stable state. 
  * Alt. stable states have been well documented in the modern day tropics, but studies documenting alternative stable states in temperate regions of the world are scarce. However, if fire/disturbance driven alternative stable states once existed in parts of the temperate zone, large scale fire suppression in N. America (@nowacki_2008) and Europe (CITE??) would have removed the vegetation-disturbance feedbacks from the landscape. 
  * However, the existance of a large ecotone from open prairies and savannas to eastern closed forests in the North American Midwest might suggest otherwise. 
  * Recent digitatization of historical records of past vegetation in the North American midwest allows us to test for the characteristic bimodality in vegetation w.r.t. climate in the past. We hypothesize that regional fire suppression efforts contirbuted to the removal of vegetation-disturbance feedbacks, leading to an increase in forests in previously savanna and open areas. 
  
  
1a. "Alternative Intro" 
  * Understanding forest response to environmental changes is a key challenge to predicting and planning for the future. Forest response may be deteriministic in some places, but non-linear and non-deterministic vegetation-climate relationships can result in divergent forest responses. In the tropics, alternative savanna and forest stable states coexist within the same climate due to vegetation-disturbance feedbacks(staver et al. ). These vegetation-disturbance feedbacks predict that increased disturbances (fire, logging, ungulates) would result in a a collapse of closed forests to the low tree density savanna state and suggest that there is large scale forest instability across the tropics (staver et al. ..).
  
  
  Savanna and forest vegetation have been proposed to be currently alternative stable states controlled by disturbance regimes in some regions of the globe (mostly in the tropics). While climate does not deterministically predict the vegetation state overall in these regions, precipitation amount, seasonality, and soil factors can all play a role. Particularly at a large regional scale, moisture gradients certainly have some control the distribution (deterministic high and low precip creates forests and savs./grasslands. respectively). However, vegetation-disturbance feedbacks are important at intermediate precipitation levels and in seasonally dry regions. Specifically, fire is associated with open savanna ecosystems with intermediate climates, where high grassy fuel loads in open understory systems promote fire spread, which prevents understory trees from establishing. However at these same climates, closed forests may be present but light limition in the understory prevents fuel buildup, suppressing the likelihood of fire (@hoffmann_2012). These vegetation-disturbance feedbacks drive will drive regions of intermediate tree cover either towards a closed forest state in the absence of disturbance, or towards an open savanna state in the presence of disturbance. Disturbance maintains alternative open and closed states, Savanna and forest stable states in these regions often results in bimodal distribution in tree cover/tree density that is not deterministically predicted by climate or environmental factors.  
  
  The instability and stochastic nature of alternative stable states and disturbance feedbacks make it difficult to predict the outcome of these vegeation processes into the future. Therefore we look at historical shifts to understand how shifting disturbances, changes in climate, etc can affect systems with alternative stable states.
  
  
  
      - These controls maintain biotic diversity, have impacts on soil carbon storage/accumulation, as well as having metrological feedbacks on microclimate.
(transition from tropics to temperate/our region )
  * While tropical and temperate climates likely interact with vegetation in different ways, the importance of fire and disturbance in maintaining temperate savanna and treeless grasslands has also been recognized. However, there has been much debate on the overarching controls of historic vegetation in this region.
    - the savanna and forest boundary in the temperate zone (PP) has been hypothesized to be controlled by climate (bryson, transeau)
    - Soil factors + climate
    - fire (grimm, nowacki & abrams)
  * However, in the temperate zone, much of the savanna-forest boundary has transitioned into a closed forest state (non-agricultural landscape). This transition has occured over a time period of large scale fire supppression (at least since the 1930's Nowacki & abrams).
  * PLS data allows us to test this hypothesis that envtl. changes (e.g. fire suppression) have resulted in a stability transition over time (sav/forest -> stable closed forest).
  
  
Intro:
  * 
  - make the key point that we went from unstable to stable 
  - also show what is going on in tropics
  - but most show instablity with  fear of 
  - our advantage is that we can see how this shift occurs
  - and we can predict this based on climate and land use
  - unstable praries? 
  
Methods
  - Add in the ipcc climate data
  - PLS-relationship with climate but with todays climate
    + gets to the point of being able to see how unstable sites chnage
    + sets us up for the future
    
  
1b. "Alternative IntroB" 
  * Savanna biomes are important in temperate/tropics because
    - high NPP contribution
    - hotspots of biodiversity
    - home to large amounts of global population
    - important to the earths carbon cycle
    - current and past environmental changes can alter the distribution and the function of savannas
    - therefore, understanding the environmental controls of these ecosystems is key to predicting the resilience of these ecosystems future environmental changes 
  * Savannna -forets as alternative states. 
  * Environmental changes in both the tropics and temperate zone have already altered distribution and savanna function. 
    -tropics (woody encroachment due to fire suppression & perhaps rising CO2)
    -temperate zone (woody encroachment associated with fire suppression)
  * These alterations might suggest changes in controls on vegetation. 
    -if vegetatation is controlled by climate factors (shift in vegetation should be explained by any shifts in climate & vegetation should be a fucntion of climate)
    -if vegetation was actually not deterministically driven by climate, and rather governed by latent fire/disturbance proceesses, then the shift in fire regime might have driven a shift in stability
  
2. Methods:
  * PLS data: Density estimation as in goring et al. 2015
  * FIA data: Citation?
  * Climatic/environmental data
    + PRISM climate CITE
    + gSSURGO soils data CITE (aggregation of data via SSURGO on demand)
    + calcaulation of P and T seasonality
    
3. Results:
  * Tree density is bimodal in the past with modes at 15 and 200 trees/ha, but density estimates from the FIA shows that it is unimodal today.
  * The distribution in tree density is not well predicted by Mean annual precipitaiton or precipitation seasonallity (). 
    + ID places that are low density predicted due to climate
    + ID places that are high density determined by climate?
    
4. Discussion:
  *Discuss places that are bimodal
  *Discuss comparison between PLS and modern landscape

### Start Paper Draft


Conceptually, biome thoery suggests that there is a predictible relationship between the global distribution of vegetation and environmental drivers. This hypothesized link between vegetation and its environment is the basis for simple ecosystem and dynamic vegetation models, which we often use to make predictions for a future under a changing climate and higher CO~2~. However, biomes with alternative states have two very different vegetation types that can occur within the same climate and environmental space. Thus, in biomes/regions with alternative stable states, vegetation is not a direct function of the environmet, make predictions into the future uncertain (CITE review paper).  


  Biomes that can switch between Savanna and forest systems are an example of alternative states that are not directly predictable from climate and environental factors. In large areas of the tropics climate and edaphic factors are uninformative in predicting distribution of tree cover, but tree cover may be a result of disturbance-vegetation feedbacks(@staver_2011). The association of open savannas regions with high fire frequencies suggest that disturbance-vegetation feedbacks play a role in maintaining savanna & forest as alternative stable states (@staver_2011). Specifically, fire is associated with open savanna ecosystems with intermediate climates, where high grassy fuel loads in open understory systems promote fire spread, which prevents understory trees from establishing. However at these same climates, closed forests may be present but light limition in the understory prevents fuel buildup, suppressing the likelihood of fire (@hoffmann_2012). These vegetation-disturbance feedbacks drive will drive regions of intermediate tree cover either towards a closed forest state in the absence of disturbance, or towards an open savanna state in the presence of disturbance. These vegetation feedback forces result in a bimodal distribution of tree cover/tree density at a landscape or regional scale, with a high frequency of open and closed ecosystems, but few ecosystems with intermediate tree cover. Thus, the existence of alternative states is demonstrated by a bimodal distribution in tree density that is not well predicted by climate, but could be attributed to endogenous feedbacks.

Savanna and forest alternative states have been well documented in the tropics(@staver_2011, @hoffmann_2012, @dantas_2016a), but have not been well documented elsewhere on the landscape. The relience of alternative states on disturbance-vegetation feedbacks would predict that alternative states are likely in fire prone regions outside of the tropics as well. However, studies documenting alternative stable states in temperate regions of the world are scarce. However, if fire/disturbance driven alternative stable states once existed in parts of the temperate zone, large scale fire suppression in N. America (@nowacki_2008) and Europe (CITE??) would have removed the vegetation-disturbance feedbacks from the landscape. 

While the Upper Midwest in North America is largely forested or agricultural land use today, historical vegetation surveys documented open savanna regions in the region before the time of European settlement (@transeau_1935, @grimm_1984, @danz_2011, @goring_2016). Several alternative hypotheses for the existance of open savanna ecosystems in the mesic/temperate midwest have been proposed, resulting in a complex understanding of the historic controls on vegetation in the past. At a very large scale, a gradual east to west moisture/precipitation gradient limits tree growth, resulting in transistions from Forest to tall, mixed, and shortgrass prairie (CITE @transeau_1935). High Temperatures could inteact with precipiation by increaseing evapotranspiration, creating drought conditions (@danz_2011). In the seasonally dry topics, the seasonality of rainfall is an important determinant of vegetation, but there is very low temperature seasonality. While the N. American midwest often experiences late summer droughts, the temperate zone experiences marked temperature seasonality (CITE for how this affects vegetation).In addition to this gradual moisture limiation, high drainage in fast draining sandy soils can create wate limitations on tree growth, creating savanna ecosystems in mesic ecosystems (@grimm_1984, CITE others). Topography can also faciliate water limitation by decreasing soil moisture on upslope sites, and altering solar insolation driven evapotranspiration (CITE ). Not all hypothesized drivers of the Midwestern savanna-forest ecotone have been deterministic; topographic fire breaks distiguish open prairie & savanna from the closed forest in the Big Woods of Minnesota (@grimm_1984) and historically forested regions of the P-F boundary in Minnesota are more topographically complex than historic prairie sites (@danz_2011). Anecdotal accounts of anthropogenic and natural prairie fires support this idea that fire disturbances were historically important influences on the past landscape (CITE). However, to date there have been no studies to document historic forest & savanna vegetation as alterative stable states (come up with a better transistion). 
  
However, if fire/disturbance driven alternative stable states once existed in parts of the temperate zone, large scale fire suppression and extensive land use change & fragmentation in N. America (@nowacki_2008, @rheumtella_2007) and Europe (CITE??) would have removed the vegetation-disturbance feedbacks from the landscape, making the alternative stable states in the temperate zone (should they exist) unobservable today. The recent digitization of pre-European settlement vegetation data in the N. American Upper Midest provides a glimpse into past vegetaton and allows us to test the hypothesis that the distribution of vegetation in the past is bimodal with respect to climate, and that the commonly cited hypothesized drivers do not predict the distribution of vegetation in the past (reword/develop the hypotheses so they are stronger).


Modern landscape is mostly forested with few savannas (@nowacki_2006), but we hypothesize that large scale fire suppression and land use have removed vegetation-disturbance feedbacks that were once on the landscape. Thus, we hypothesize that vegetation in the PLS era will have a bimodal distribution in tree denisty (high frequency of low density and high density sites, few intermediates) that is not well predicted by climate. However, in the absence of fire and disturbances, we hypothesize that tree density on the modern landscape will not be bimodal, but may be better predicted by climate.


##Key questions we aim to answer in this analysis:
1. Was the N.American pre-euro settlement tree cover/tree density bimodal? Is the modern landscape bimodal?
2. Does climate explain the distribution of tree density in either the past or the modern landscape?
3. Do soil factors/elevation explain tree density in either the past or the modern landscape?
4. What is the climate/soil/environmental space where the past had alternative stable density states? How bimodal is the distribution? Where is this located within the N. American Midwest?
5. Based on this climate/soil/environmental space, where should this bimodality be observed? (acknowledging that climate has changed over the last century)

##Methods:
*Public Land Survey Data:*
The Public Land Survey was commissioned by the U.S. General Land Office to assess the quality of land/timber and assign land titles for Euro-american settlers. The surveyors placed corner posts at every 1mile section corners in a grid within each township. At these section corners, and at 1/4 section corners, the surveyors would record the distance and azimuth from the corner to the nearest two trees, the species of the nearest two trees, and the diameter at breast height (DBH) of those trees. Afte these historic records are digitized (cite Mladenoff et al. ), we estimate the denisty and basal area at each corner point using the unbiased morista density estimator (@goring_2016, CITE Cogbill). Tree density is averaged across 8km grid cells in the upper Midwest.

*Forest Inventory Analysis Data:*

Add FIA data methods from Sean/Simon/Jack

*Prism Data*

  * Climate data come from Temperature and Precipitation PRISM datasets. Modern climate is the 30-year Normals dataset and Historical climate is estimated as the average annual Temperature and average annual Precipiation over the 1895-1910 period. 
  * Precipitation seasonality was calculated from Monthly Prism datasets as follows: 
  
SI = sum 1-12(abs(mi - P/12))/P * 100

Temperature is calculated using the coefficient of variation method
TSI = sd(m1....m12)/Tavgannual *100
 

  
*gSSURGO soil data*

  Soils data are derived from statewide gSSURGO 10m raster data product (<https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/home/?cid=NRCS142P2_053628>).  The weighted averages from the top 30cm of the soil were calculated for % sand, available water content (awc), and saturated hydraulic conductivity (ksat) soil parameters using the gSSURGO On-Demand ArcGIS toolbox (<https://github.com/ncss-tech/ssurgoOnDemand.git>). Weighted averages were calculated on the statewide soil raster datasets for Minnesota, Michigan, Wisconsin, Indiana, and Illinois, then weighted average rasters were mosaicked together to produce one single raster dataset. Maps of soil parameters were then aggregated to a 1km grid scale and an 8km Great Lakes St. Lawrence projected grid scale (PalEON dataset scale).

*Pricipal Component Analysis*

Since many climate and soils variables are often correlated, a pricipal components analysis was conducted to reduce dimensions and co-linearity in the environmental data. PCA was coducted on the scaled variables of historic MAP, historic Mean temperature, historic Precipitation Seasonality Index, Historic Tempearture Seasonality, AWC, and %sand. The 1st Principal component was then used as a covariate when assessing bimodality. 

  
*Bimodality analysis*

Criteria for bimodality uses a both a bimodality coefficient (BC) and Hartigans Diptest for unimodality. Bimodality Coefficient is calculated from size, skewness, and kurtosis of the distributions (Pfister et al. 2013). A BC greater than 0.556 suggests bimodality. Bimodality coefficient (BC) is calculated from the distribuiton of data as follows using the R package 'modes':

BC = $\frac{(skew^2 + 1)}{(kurtosis + 3)*\frac{(n-1)^2}{(n-2)*(n-3)}}$

Desnity distributions of the PLS and FIA data were estimated. We then calculated the BC and performed Hartigan's diptest for unimodaltity for the on these smoothed density distribuitons for the PLS and FIA overall, and the BC within different bins of precipitation and the 1st Principal Component. This provides one BC value for a given range of precipitation/PC and whether the distribution is significantly different from a unimodal distribution. These ranges are used to determine the climate space where savannas and closed forests coexist.  


*Generalized Additive Models*

In addition to evaluating the BC for ranges of data, we developed several generalized additive models (GAMs) to determine if tree density can be deterministically predicted by climate and/or soils. GAMs were developed with both strictly additive terms and with flexible smooth terms. The full PLS data was separated into two random halves that make up the testing and training datasets. GAM's were developed with the training dataset, and prediction error was estimated using the test dataset. Model parsimony was evaluated basing on AIC values, and model fit was assessed using RMSE. 


##Results:

*Distribution of data*

The distribution of tree density in the past is significantly bimodal across the entire upper midwest, with a prominant low tree density mode at 30 trees/ha and a high tree density mode at 205 trees/ha (Diptest p < 0.05, BC = 0.74306). While Hartigan's diptest shows shows a significant multimodality to the Modern FIA tree denstity, the two modes both occur at intermediate and high tree denisty (147 trees/ha, and 550 trees/ha).

*PCA* 

Principal component 1 (PC1) explains 54% of variance and component 2 (PC2) explains 29% of the variance. Past precipitation and Past Temperature both have strong positive loadings on PC1, while temperature seasonality and precipitation seasonality index both have negative loadings fro PC1. Sand has the strongest negative loading and AWC has strongest positive loading on PC2. Plotting density/vegetatation type in Principal component space does not separate vegeatation into savanna, prairie, and forest.  

Additionally, the biplot for the Principal Components Analysis:
![](outputs/v1.6-5/full/pca_biplot.png)

*Bimodality*

![](outputs/v1.6-5/tree_density_maps_PLS_FIA.png)
![](outputs/v1.6-5/PLS__full_tree_density_map.png)

## Q1. Was the N.American pre-euro settlement tree cover/tree density bimodal? Is the modern landscape bimodal?

Ans. Public land survey tree density is bimodal and FIA tree density is not:

![](outputs/v1.6-5/FIA_PLS_hists.png) 

Additionally, places that historically had low tree density in the past now have higher tree density, while those that were dense in the past have decreased in tree density:


![](outputs/v1.6-5/density_difference_plot.png)

Using the climate space with reduced dimensionality (PC1) and the vegetation classificaitons from rheumtella, we can map out places where tree density was bimodal in the past:

![](outputs/v1.6-5/full/PLS_PC1_PC2_map.png)

![](outputs/v1.6-5/FIA_PC1_PC2_map.png)

*Future Forest Stability*

Using our new understanding of the the climate space where forests are bimodal (unstable) in the past, and now, we can make broad predictions for the future stability of midwestern forests. If the relationship between climate/soils and PLS vegetation held in the future, the climate changes projected under the RCP 2.6, RCP4.5, and RCP 8.5 emmissions scenarios (for 1 model CCESM4) would result in some increases and spatial shifts in the instability of Midwestern forests.  

![](ouputs/v1.6-5/full/RCP_scenario_PC1_maps.png)

However, the current regime of fire suppression is likely to remain, and starting with a modern relationship between climate/soils and modern vegetaion, the climate changes projected under the RCP 2.6, RCP4.5, and RCP 8.5 emmissions scenarios (again for CCESM4 only) would result in closed forests in the Midwest maintaining, or increasing ecosystem stability. 

![](ouputs/v1.6-5/RCP_scenario_PC1_maps_FIA.png)

*Predicting Tree density (GAMs)*

Gam model selection for the model with the lowest AIC value yeilded the model: 

PLS tree density ~ s(MAP) + s(pasttmean) + s(deltaT) + s(deltaP)

While AIC suggests this is the best model, it only explains 61% of the Deviance and has high Mean squared prediction error for predicting the test data set (MSPE = 5976.366). 

```{r, echo = FALSE}

suppressMessages(library(mgcv))
suppressMessages(library(caTools))
suppressMessages(library(ggplot2))

#dens.pr <- read.csv("data/midwest_pls_density_pr_alb1.6-5.csv") # just with grid cells that have both pls & FIA
#dens.pr <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/midwest_pls_full_density_pr_alb1.6-5.csv") # full set of PLS data
#hist(dens.pr$PLSdensity, breaks = 50)
dens.pr <- read.csv("data/PLS_full_dens_pr_with_bins.csv")

fiadens <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/dens_pr_PLS_FIA_with_cov.csv")

# split into test and training datasets:
Y <- dens.pr$PLSdensity
msk <- sample.split( Y, SplitRatio = 1/2, group = NULL )
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]

#split FIA data into test and training datasets
Y <- fiadens$FIAdensity
msk <- sample.split( Y, SplitRatio = 1/2, group = NULL )
#table(Y,msk)

trainf <- dens.pr[msk,]
testf <- dens.pr[!msk,]


PLS.gam1 <-gam(PLSdensity ~  s(MAP1910), data = train, family = poisson(link = "log"))
PLS.gam1L <-gam(PLSdensity ~  MAP1910, data = train)


PLS.gam2 <- gam(PLSdensity ~ s(pasttmean) , data = train)
PLS.gam2L <- gam(PLSdensity ~ pasttmean , data = train)
#summary(PLS.gam2) #explains 15.8% deviance
#plot(PLS.gam2)

PLS.gam3 <- gam(PLSdensity ~ s(pastdeltaP),data = train)
PLS.gam3L <- gam(PLSdensity ~ pastdeltaP,data = train)
#summary(PLS.gam3) #explains 6.07% deviance

PLS.gam4 <- gam(PLSdensity ~ s(deltaT), data = train)
PLS.gam4L <- gam(PLSdensity ~ deltaT, data = train)
#summary(PLS.gam4) #explains 6.07% deviance

PLS.gam5 <- gam(PLSdensity ~ s(awc),data = train)
PLS.gam5L <- gam(PLSdensity ~ awc, data = train)
#summary(PLS.gam5) #explains 12.5% of deviance

PLS.gam6 <- gam(PLSdensity ~ s(sandpct), data = train)
PLS.gam6L <- gam(PLSdensity ~ sandpct, data = train)
#summary(PLS.gam6) #explains 12.5% of deviance



PLS.gam7 <- gam(PLSdensity ~ s(pasttmean) + s(MAP1910) , data = train)
PLS.gam7L <- gam(PLSdensity ~ pasttmean + MAP1910 ,  data = train)
#summary(PLS.gam7) #explains 41% deviance
#summary(PLS.gam7L) # explains 19.6%

PLS.gam8 <- gam(PLSdensity ~ s(awc) +s(sandpct), data = train )
PLS.gam8L <- gam(PLSdensity ~ awc + sandpct, data = train )
#summary(PLS.gam8) #explains 28% of deviance

PLS.gam9 <- gam(PLSdensity ~ s(MAP1910) + s(pasttmean) + s(sandpct), data = train)
PLS.gam9L <- gam(PLSdensity ~ MAP1910 + pasttmean + sandpct, data = train)
#summary(PLS.gam9) #explains 39% deviance
#summary(PLS.gam9L)
#plot(PLS.gam6)


PLS.gam10 <- gam(PLSdensity ~ s(MAP1910) +s(pasttmean) + s(awc), data = train)
PLS.gam10L <- gam(PLSdensity ~ MAP1910 + pasttmean + awc, data = train)

#summary(PLS.gam10) #explains 41.3% of deviance
#plot(PLS.gam10)

PLS.gam11 <- gam(PLSdensity ~ s(MAP1910)  +s(pasttmean) +s(sandpct) + s(awc), data = train)
PLS.gam11L <- gam(PLSdensity ~ MAP1910  + pasttmean + sandpct + awc, data = train)

#summary(PLS.gam8) # explains 41% of deviance
PLS.gam12 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), data = train)
PLS.gam12L <- gam(PLSdensity ~ MAP1910  + pasttmean + pastdeltaP, data = train)

PLS.gam13 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), data = train)
PLS.gam13L <- gam(PLSdensity ~ MAP1910  + pasttmean + pastdeltaP, data = train)

PLS.gam13 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(deltaT), data = train)
PLS.gam13L <- gam(PLSdensity ~ MAP1910  + pasttmean + deltaT, data = train)

PLS.gam14 <- gam(PLSdensity ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP), data = train, family = quasipoisson(link = "log"))
PLS.gam14L <- gam(PLSdensity ~ MAP1910  + pasttmean + deltaT + pastdeltaP, data = train)

AIC.df<- AIC(PLS.gam1, PLS.gam2, PLS.gam3, PLS.gam4, PLS.gam5, PLS.gam6, PLS.gam7, PLS.gam8, PLS.gam9,PLS.gam10,PLS.gam11,PLS.gam12,PLS.gam13,PLS.gam14 , PLS.gam1L, PLS.gam2L, PLS.gam3L, PLS.gam4L, PLS.gam5L, PLS.gam6L, PLS.gam7L, PLS.gam8L, PLS.gam9L, PLS.gam10L,PLS.gam11L,PLS.gam12L,PLS.gam13L,PLS.gam14L)

AIC.df$modeltype <- c(rep('smooth', 14), rep('linear', 14))

AIC.df$formula <- c(PLS.gam1$formula, PLS.gam2$formula, PLS.gam3$formula, PLS.gam4$formula, PLS.gam5$formula, PLS.gam6$formula, PLS.gam7$formula, PLS.gam8$formula, PLS.gam9$formula,PLS.gam10$formula,PLS.gam11$formula,PLS.gam12$formula,PLS.gam13$formula,PLS.gam14$formula , PLS.gam1L$formula, PLS.gam2L$formula, PLS.gam3L$formula, PLS.gam4L$formula, PLS.gam5L$formula, PLS.gam6L$formula, PLS.gam7L$formula, PLS.gam8L$formula, PLS.gam9L$formula, PLS.gam10L$formula,PLS.gam11L$formula,PLS.gam12L$formula,PLS.gam13L$formula, PLS.gam14L$formula )

AIC.df<- AIC.df[order(AIC.df$AIC),]
library(knitr)
library(pander)
AIC.df$model <- rownames(AIC.df)

#calculate prediction error:
msqe<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$PLSdensity - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

AIC.df$MSPE <- 1

#add prediction error ot AIC dataframe

for (i in 1: length(AIC.df$model)){
AIC.df[i,'MSPE'] <- msqe(get(AIC.df[i,"model"]), test)
}
pander(AIC.df[,c("model","modeltype", "formula", "df", "AIC", "MSPE")], split.cells = 30)

```

Taking a closer look at PLS.GAM14, we see some overestimation in open savanna areas and underestimation in closed forestion regions.

```{r, echo = FALSE}
suppressMessages(library(maps))
suppressMessages(library(sp))
suppressMessages(library(rgeos))
suppressMessages(library(visreg))
all_states <- map_data("state")
states <- subset(all_states, region %in% c(  'minnesota','wisconsin','michigan',"illinois",  'indiana') )
coordinates(states)<-~long+lat
class(states)
proj4string(states) <-CRS("+proj=longlat +datum=NAD83")
mapdata<-spTransform(states, CRS('+init=epsg:3175'))
mapdata <- data.frame(mapdata)
cbpalette <- c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837")
#map out 

# plot the predicted response fields to these variables

#visreg2d(PLS.gam11, xvar='MAP1910', yvar='pasttmean', scale='response')
#visreg2d(PLS.gam11, xvar='MAP1910', yvar='pastdeltaP', scale='response')
#visreg2d(PLS.gam11, xvar='MAP1910', yvar='deltaT', scale='response')

map.pred.density <- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
plot(testdata$MAP1910, ypred, pch = 16, xlab = "MAP", ylab = "Predicted")

plot(testdata$pasttmean, ypred, pch = 16, xlab = "pasttmean", ylab = "Predicted")

testdata$ypred <- ypred

all_states <- map_data("state")
states <- subset(all_states, region %in% c(  'minnesota','wisconsin','michigan',"illinois",  'indiana') )
coordinates(states)<-~long+lat
class(states)
proj4string(states) <-CRS("+proj=longlat +datum=NAD83")
mapdata<-spTransform(states, CRS('+init=epsg:3175'))
mapdata <- data.frame(mapdata)
cbpalette <- c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837")

ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=testdata, aes(x=x, y=y, fill = ypred))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="Predicted tree density") + 
  scale_fill_gradientn(colours = c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837"), limits = c(0,700), name ="Tree \n Density \n (trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw()
#outdata <- testdata
}

# make a function to extracted predictions from a model
get.preds <- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")

testdata$ypred <- ypred

testdata
}

predicted <- get.preds(PLS.gam14L, test)
#summary(predicted$ypred)

predicted <- get.preds(PLS.gam14, test)
summary(predicted$ypred)



#calcuated the squared error for each prediction
msqe<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$PLSdensity - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}



# plot predicted vs. observed 
ggplot(predicted, aes(PLSdensity,ypred, color = MAP1910)) +geom_point() + theme_bw()+geom_abline(intercept = 0, slope = 1, color = 'red', size = 2) + ylim (-5, 600) + ggtitle('Predicted vs. Observed') + ylab('Predicted tree density') + xlab('Observed tree density')
```
The predicted vs. observed plot shows overestimation of PLS tree density in Low density areas and underestimation of PLS tree density in High density areas. Below we map out the predictions and prediction errors in space. Note that the predictions here are overall much lower than the observations

```{r, echo = FALSE}

# plot the predicted tree denisty in the map
ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=predicted, aes(x=x, y=y, fill = ypred))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="Predicted tree density from PLSgam.14") + 
  scale_fill_gradientn(colours = c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837"), limits = c(0,700), name ="Tree \n Density \n (trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw()
```

Mapping out predicted - observed for each grid cell in the test dataset. This  map also shows that the savannas are generally overestimated in terms of tree density, while the norther closed forests tend to be underestimated. 
```{r, echo = FALSE}

suppressMessages(library(RColorBrewer))
# calculate predicted - observed
predicted$podiff <- predicted$ypred - predicted$PLSdensity

Sd = rep(0,length(predicted$podiff))
  Sd[which(predicted$podiff>0 & predicted$podiff<=10)] = 1
  Sd[which(predicted$podiff>10 & predicted$podiff<=50)] = 2
  
  Sd[which(predicted$podiff>50 & predicted$podiff<=100)] = 3
  Sd[which(predicted$podiff>100) ] = 4
  Sd[which(predicted$podiff== 0)] = 0
   Sd[which(predicted$podiff>=-10 & predicted$podiff<0)] = -1
  Sd[which(predicted$podiff>-50 & predicted$podiff<=-10)] = -2
  
  Sd[which(predicted$podiff> -100 & predicted$podiff<=-50)] = -3
  Sd[which(predicted$podiff< -100) ] = -4
  Sd = factor(Sd,levels=-4:4)
  levels(Sd) = c(">-100","(-100,-50]","(-50, -10]","(-10,0]",'0','(0,10]','(10,50]','(50, 100]','(100,200]')
  
  predicted$errordiscrete <- Sd
  
 gs.pal <- colorRampPalette(brewer.pal(11,"PRGn"))


# map out predicted - observed using discrete scale
ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=predicted, aes(x=x, y=y, fill = errordiscrete))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="Predicted - Obs from Model 14") +scale_fill_manual(values=gs.pal(9),drop=FALSE) +
  coord_equal()+theme_bw()
```

When we compare the results from the above map to the map where PLS tree density is bimodal (according to Hartigan's diptest and bimodality coefficient), we see that the GAM model and the bimodality analysis converge on similar answers because the GAM model cannot predict the regions that are bimodal (have both savanna and forests) in PC1 climate space very well. 

Specifically,the GAM model overestimates bimodal & stable savannas, slightly underestimates bimodal forests, and does okay at estimating some stable forests (boxplots & histograms).

```{r, echo = FALSE}
suppressMessages(library(modes))
get.bimodal.5c <- function(data, binby, density){
  bins <- as.character(unique(data[,binby]))
  coeffs <- matrix(NA, length(bins), 2)
  for (i in 1:length(bins)){
    coeffs[i,1]<- bimodality_coefficient(na.omit(data[data[,binby] %in% bins[i], c(density)]))
    coeffs[i,2] <- diptest::dip.test(na.omit(density(data[data[,binby] %in% bins[i], c(density)])$y))$p
  }
  coeffs[is.na(coeffs)]<- 0 # replace NANs with 0 values here
  coef.bins<- data.frame(cbind(coeffs, bins))
  coef.bins$BC <- as.numeric(as.character(coef.bins$V1))
  coef.bins$dipP <- as.numeric(as.character(coef.bins$V2))
  merged <- merge(coef.bins, dens.pr, by.x = "bins",by.y = binby)
  #define bimodality
  merged$bimodal <- "Stable"
  merged[merged$BC >= 0.5 & merged$dipP <= 0.05,]$bimodal <- "Bimodal"
  
  #define bimodal savanna/forest and not bimodal savanna & forest 
  if(density == "PLSdensity"){
    merged$classification <- "test"
    merged$classification <- paste(merged$bimodal, merged$ecotype)
    merged[merged$classification %in% 'Bimodal prairie',]$classification <- "Prairie"
    merged[merged$classification %in% 'Stable prairie',]$classification <- "Prairie"
    
    }else{
    merged$classification <- "test"
    merged$classification <- paste(merged$bimodal, merged$fiaecotype)
    
  }
  
merged
  
}

test <- test[complete.cases(test),]

merged <- get.bimodal.5c(data = test, binby = "PC1bins", density = "PLSdensity")
merged <- merge(merged, predicted[,c("x", "y", "ypred", "errordiscrete", "podiff")], by = c('x','y'))


ggplot(merged, aes(x = classification, y = podiff))+geom_boxplot()+xlab("Predicted - Observed for different Bimodal regions")

#ggplot(merged, aes(x = errordiscrete))+geom_bar()+facet_grid(classification~., scales = 'free')


#plot historgram sof the data
ggplot(merged, aes(x = podiff, fill = classification)) + geom_vline( aes(xintercept=0), colour="red") +geom_histogram()+facet_grid(classification~., scales = 'free') + xlab("Predicted - Observed for different Bimodal regions")

```

```{r, echo = FALSE}


# plotting predicted - observed in different climate spaces
ggplot() + geom_point(data = predicted, aes(x= MAP1910, y = pasttmean, color = errordiscrete)) +scale_color_manual(values=gs.pal(9),name = "Pred-Obs",drop=FALSE) 
```

## Looking at a model that includes soils as well:

Since PLS.GAM14 included terms only relating to climate and climate seasonality, we can look another model with a low AIC, but that includes soil parameters to see if soils impact prediction of PLS tree density in an ecologically meaningful way. 
The next closest model is PLS.gam11:

PLSdensity ~ s(MAP1910) + s(pasttmean) + s(sandpct) + s(awc)

Here we plot the predicted vs. observed of for this model:
```{r, echo = FALSE}
predicted <- get.preds(PLS.gam11, test)
#summary(predicted)

ggplot(predicted, aes(PLSdensity,ypred, color = MAP1910)) +geom_point() + theme_bw()+geom_abline(intercept = 0, slope = 1, color = 'red', size = 2) + ylim (-5, 600) + ggtitle('Predicted vs. Observed') + ylab('Predicted tree density') + xlab('Observed tree density')

```

This model also overestimates the low tree density regions and underestimates the high tree density regions. 

```{r, echo = FALSE}

# plot the predicted tree denisty in the map
ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=predicted, aes(x=x, y=y, fill = ypred))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="Predicted tree density from Model 11") + 
  scale_fill_gradientn(colours = c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837"), limits = c(0,700), name ="Tree \n Density \n (trees/hectare)", na.value = 'darkgrey') +
  coord_equal()+theme_bw()


# calculate predicted - observed
predicted$podiff <- predicted$ypred - predicted$PLSdensity
Sd = rep(0,length(predicted$podiff))
  Sd[which(predicted$podiff>0 & predicted$podiff<=10)] = 1
  Sd[which(predicted$podiff>10 & predicted$podiff<=50)] = 2
  
  Sd[which(predicted$podiff>50 & predicted$podiff<=100)] = 3
  Sd[which(predicted$podiff>100) ] = 4
  Sd[which(predicted$podiff== 0)] = 0
   Sd[which(predicted$podiff>=-10 & predicted$podiff<0)] = -1
  Sd[which(predicted$podiff>-50 & predicted$podiff<=-10)] = -2
  
  Sd[which(predicted$podiff> -100 & predicted$podiff<=-50)] = -3
  Sd[which(predicted$podiff< -100) ] = -4
  Sd = factor(Sd,levels=-4:4)
  levels(Sd) = c(">-100","(-100,-50]","(-50, -10]","(-10,0]",'0','(0,10]','(10,50]','(50, 100]','(100,200]')
  
  predicted$errordiscrete <- Sd
  
 gs.pal <- colorRampPalette(brewer.pal(11,"PRGn"))
 
  ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+geom_raster(data = predicted, aes(x=x, y=y,fill=errordiscrete))+
    scale_fill_manual(values=gs.pal(9),drop=FALSE) + theme_bw() +
    geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+ggtitle("Predicted - Obs. discrete scale") + coord_equal() 
```
This model also underestimates the northern WI & UP forests, and overstimates many regions in the prairie/savanna.
So far, the under and over estimation of the model doesn't appear systematic from these graphs, but it is hard to tell. It just appears that the prairie regions are being over estimated, but the forest regions are being underestimated.

```{r, echo = FALSE}

# plotting predicted - observed in different climate spaces
ggplot() + geom_point(data = predicted, aes(x= MAP1910, y = pasttmean, color = errordiscrete))+scale_color_manual(values=gs.pal(9),drop=FALSE) 

ggplot() + geom_point(data = predicted, aes(x= MAP1910, y = sandpct, color = errordiscrete))+scale_color_manual(values=gs.pal(9),drop=FALSE) 

ggplot() + geom_point(data = predicted, aes(x= MAP1910, y = awc, color = errordiscrete))+ scale_color_manual(values=gs.pal(9),drop=FALSE)  

ggplot() + geom_point(data = predicted, aes(x= pasttmean, y = awc, color = errordiscrete))+ scale_color_manual(values=gs.pal(9),drop=FALSE) 

ggplot() + geom_point(data = predicted, aes(x= pasttmean, y = awc, color = errordiscrete))+ scale_color_manual(values=gs.pal(9),drop=FALSE)  


# histograms of soil variables


# break up the dataset by sand % 
predicted$sandgroup <- '59-88%'
predicted[predicted$sandpct <59.04,]$sandgroup <- '29-59%'
predicted[predicted$sandpct < 29.52,]$sandgroup <- '0-29%'

# plot the predicted - obs by bins of sand
ggplot() + geom_point(data = predicted, aes(x= pasttmean, y = MAP1910, color = errordiscrete))+ scale_color_manual(values=gs.pal(9),drop=FALSE) +facet_grid(~sandgroup) + ggtitle('predicted-observed by sand%')

# plot the predicted by bins of sand
ggplot() + geom_point(data = predicted, aes(x= pasttmean, y = MAP1910, color = ypred))+ ggtitle ('predictions by sand %') + facet_grid(~sandgroup)


```



## Predicting Forest vs. Savanna (not density)

The above models are predicting density (continious variable) from continous envrionmental and climate covariates. However, we can also use the savanna/forest density classificaitons as our y variable and  predict the probability a grid cell is forest (ecocode = 1, PLS density > 47 trees/ha) and savannna (ecocode = 0, PLSdensity < 47 trees/ha & >0.5 trees/ha) from continous environmental and climate covariates. 


This method has the benefit of predicting the probability of forest (or the probability of savanna) given certain environmental conditions. For this analysis, we exclude prairie sites

```{r echo = FALSE}
dens.pr <- read.csv("C:/Users/JMac/Documents/Kelly/biomodality/data/midwest_pls_full_density_pr_alb1.6-5.csv") 

# dummyvariables for logistic regression:
dens.pr$ecocode <- 0
dens.pr[dens.pr$ecotype %in% 'Forest', ]$ecocode <- 1
dens.pr<- dens.pr[!dens.pr$ecotype %in% 'prairie',]

#split training and testing
Y <- dens.pr$PLSdensity
msk <- sample.split( Y, SplitRatio = 1/2, group = NULL )
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]


#plot(dens.pr$sandpct, dens.pr$ecotype)


PLS.lgr1 <-gam(ecocode ~  s(MAP1910), family = 'binomial',data = train)
PLS.lgr1L <-gam(ecocode ~  MAP1910, family = 'binomial',data = train)


PLS.lgr2 <- gam(ecocode ~ s(pasttmean) , family = 'binomial',data = train)
PLS.lgr2L <- gam(ecocode ~ pasttmean , family = 'binomial',data = train)
#summary(PLS.lgr2) #explains 15.8% deviance
#plot(PLS.lgr2)

PLS.lgr3 <- gam(ecocode ~ s(pastdeltaP), family = 'binomial',data = train)
PLS.lgr3L <- gam(ecocode ~ pastdeltaP, family = 'binomial',data = train)
#summary(PLS.lgr3) #explains 6.07% deviance

PLS.lgr4 <- gam(ecocode ~ s(deltaT), family = 'binomial',data = train)
PLS.lgr4L <- gam(ecocode ~ deltaT, family = 'binomial',data = train)
#summary(PLS.lgr4) #explains 6.07% deviance

PLS.lgr5 <- gam(ecocode ~ s(awc), family = 'binomial',data = train)
PLS.lgr5L <- gam(ecocode ~ awc, family = 'binomial',data = train)
#summary(PLS.lgr5) #explains 12.5% of deviance

PLS.lgr6 <- gam(ecocode ~ s(sandpct), family = 'binomial',data = train)
PLS.lgr6L <- gam(ecocode ~ sandpct, family = 'binomial',data = train)
#summary(PLS.lgr6) #explains 12.5% of deviance



PLS.lgr7 <- gam(ecocode ~ s(pasttmean) + s(MAP1910) ,  family = 'binomial',data = train)
PLS.lgr7L <- gam(ecocode ~ pasttmean + MAP1910 ,  family = 'binomial',data = train)
#summary(PLS.lgr7) #explains 41% deviance
#summary(PLS.lgr7L) # explains 19.6%

PLS.lgr8 <- gam(ecocode ~ s(awc) +s(sandpct), family = 'binomial',data = train )
PLS.lgr8L <- gam(ecocode ~ awc + sandpct, family = 'binomial',data = train )
#summary(PLS.lgr8) #explains 28% of deviance

PLS.lgr9 <- gam(ecocode ~ s(MAP1910) + s(pasttmean) + s(sandpct), family = 'binomial',data = train)
PLS.lgr9L <- gam(ecocode ~ MAP1910 + pasttmean + sandpct, family = 'binomial',data = train)
#summary(PLS.lgr9) #explains 39% deviance
#summary(PLS.lgr9L)
#plot(PLS.lgr6)


PLS.lgr10 <- gam(ecocode ~ s(MAP1910) +s(pasttmean) + s(awc), family = 'binomial',data = train)
PLS.lgr10L <- gam(ecocode ~ MAP1910 + pasttmean + awc, family = 'binomial',data = train)

#summary(PLS.lgr10) #explains 41.3% of deviance
#plot(PLS.lgr10)

PLS.lgr11 <- gam(ecocode ~ s(MAP1910)  +s(pasttmean) +s(sandpct) + s(awc), family = 'binomial',data = train)
PLS.lgr11L <- gam(ecocode ~ MAP1910  + pasttmean + sandpct + awc, family = 'binomial',data = train)

#summary(PLS.lgr8) # explains 41% of deviance
PLS.lgr12 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP),family = 'binomial', data = train)
PLS.lgr12L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = train)

PLS.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(pastdeltaP), family = 'binomial',data = train)
PLS.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + pastdeltaP, family = 'binomial',data = train)

#PLS.lgr13 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT), family = 'binomial',data = train)
#PLS.lgr13L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT, family = 'binomial',data = train)

PLS.lgr14 <- gam(ecocode ~ s(MAP1910)  + s(pasttmean) + s(deltaT) + s(pastdeltaP), family = 'binomial',data = train)
PLS.lgr14L <- gam(ecocode ~ MAP1910  + pasttmean + deltaT + pastdeltaP, family = 'binomial',data = train)

AIC2.df<- AIC(PLS.lgr1, PLS.lgr2, PLS.lgr3, PLS.lgr4, PLS.lgr5, PLS.lgr6, PLS.lgr7, PLS.lgr8, PLS.lgr9,PLS.lgr10,PLS.lgr11,PLS.lgr12,PLS.lgr13,PLS.lgr14 , PLS.lgr1L, PLS.lgr2L, PLS.lgr3L, PLS.lgr4L, PLS.lgr5L, PLS.lgr6L, PLS.lgr7L, PLS.lgr8L, PLS.lgr9L, PLS.lgr10L,PLS.lgr11L,PLS.lgr12L,PLS.lgr13L,PLS.lgr14L)




AIC2.df$modeltype <- c(rep('smooth', 14), rep('linear', 14))

AIC2.df$formula <- c(PLS.lgr1$formula, PLS.lgr2$formula, PLS.lgr3$formula, PLS.lgr4$formula, PLS.lgr5$formula, PLS.lgr6$formula, PLS.lgr7$formula, PLS.lgr8$formula, PLS.lgr9$formula,PLS.lgr10$formula,PLS.lgr11$formula,PLS.lgr12$formula,PLS.lgr13$formula,PLS.lgr14$formula , PLS.lgr1L$formula, PLS.lgr2L$formula, PLS.lgr3L$formula, PLS.lgr4L$formula, PLS.lgr5L$formula, PLS.lgr6L$formula, PLS.lgr7L$formula, PLS.lgr8L$formula, PLS.lgr9L$formula, PLS.lgr10L$formula,PLS.lgr11L$formula,PLS.lgr12L$formula,PLS.lgr13L$formula, PLS.lgr14L$formula )

AIC2.df<- AIC2.df[order(AIC2.df$AIC),]
library(knitr)
library(pander)
AIC2.df$model <- rownames(AIC2.df)

#calculate prediction error:
msqe.code<- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
testdata$ypred <- ypred

predicted<- testdata
  
predicted$sqerr <- (predicted$ecocode - predicted$ypred)^2
mean(predicted$sqerr, na.rm = TRUE)
}

AIC2.df$MSPE <- 1

#add prediction error ot AIC dataframe

for (i in 1: length(AIC2.df$model)){
AIC2.df[i,'MSPE'] <- msqe.code(get(AIC2.df[i,"model"]), test)
}
pander(AIC2.df[,c("model","modeltype", "formula", "df", "AIC", "MSPE")], split.cells = 30)


```
Looks like model number 14 with just Mean Annual Precipitation has lowest AIC for the logistic/binomial model. 
Lets map out the probability of forest based on model with the lowest AIC value:

forest type ~ s(MAP1910)+ s(pasttmean) + s(deltaT) +   s(pastdeltaP)

The smooth predictors in this model are the same as the smooth predictors in the denisty model
```{r, echo = FALSE}

library(visreg)
map.preds <- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")
plot(testdata$MAP1910, ypred, pch = 16, xlab = "MAP", ylab = "Predicted")

plot(testdata$pasttmean, ypred, pch = 16, xlab = "pasttmean", ylab = "Predicted")

testdata$ypred <- ypred
ggplot(testdata, aes(x = x, y = y, color = ypred))+geom_point() + theme_bw() +ggtitle ('Probability of forest') 
#outdata <- testdata
}

get.preds <- function(model, testdata){
ypred <- predict(model, newdata = testdata, type="response")

testdata$ypred <- as.vector(ypred)

testdata
}

#map.preds(PLS.lgr14, test)

preds.df <- data.frame(get.preds(PLS.lgr14, test))
#hist(preds.df$ypred, breaks = 25)
#summary(preds.df$ypred)

# plot the predicted response to these variables


preds.df$predcode <- "savanna"
preds.df <- preds.df[complete.cases(preds.df),]
preds.df[preds.df$ypred < 0.7,]$predcode <- "savanna or forest"
preds.df[preds.df$ypred > 0.3,]$predcode <- "savanna or forest"
preds.df[preds.df$ypred >= 0.7,]$predcode <- "forest"
preds.df[preds.df$ypred <= 0.3,]$predcode <- "savanna"


#ggplot(preds.df, aes(x, y, color = predcode)) + geom_point() + theme_bw()

ggplot()+ geom_polygon(data = mapdata, aes(group = group,x=long, y =lat), fill = 'darkgrey')+
  geom_raster(data=preds.df, aes(x=x, y=y, fill = predcode))+
  geom_polygon(data = mapdata, aes(group = group,x=long, y =lat),colour="black", fill = NA)+
  labs(x="easting", y="northing", title="Probability of forest from Model 5") + scale_fill_manual(values = c(
      #, # light green
      'red', # dark teal
      '#8c510a', # red
      #'#d8b365', # light tan
      'forestgreen',
      #'#fee08b', # tan
      '#01665e',
      'black'), limits = c('savanna or forest' ,'savanna', 'forest'))+
    theme_bw()+
  coord_equal()+theme_bw()

```

The above map shows 'savana or forest' places where the binomial familiy model predicted between 30-70% probability of forest. There are some places where the model predicts deterministic forest and deterministic savanna. 

The main effect on predicted forest here is temperature and temperature seasonality.

```{r, echo = FALSE}
plot(PLS.lgr14)

ggplot(preds.df, aes(x = MAP1910, y = ypred, color = pasttmean)) + geom_point() + theme_bw() + ylab('predicted p(forest)') + xlab("observed PLS density")


```

## It seems like we could make an argument for using the pls density GAMs or the PLS binomial family GAM models and that the analysis of both might end up in supplemental materials. 

















#text left over from previous update

## Q2. Does climate explain the distribution of tree density in either the past or the modern landscape?

The past and modern climate space of the Midwest is broad spans a large range of precipitation and temperature. 

![](outputs/v1.6-5/precip_vs_temp_FIA_PLS.png)

PLS & FIA tree density are not readily explained by the gradient in Precipitation, but tree denisty bimodality appears to occur between 600-900 mm/year in the past. 

![](outputs/FIA_PLS_hexbinplots.png) 

PLS & FIA density are not obviously explained as a function of mean annual temperature, but the bimodality in tree density appears to occur between 0-10 DegC in the past:

![](outputs/FIA_PLS_temp_hexbinplots.png)


##Q3. Do soil factors/elevation explain tree density in either the past or the modern landscape?

Ans. % Sand, Available Water Content (awc), and saturated hydraulic conductivity (ksat) do not explain tree density overall on their own. Additionally, PC1 and PC2 from a Principle Components Analysis do not explain tree density.


![](outputs/v1.6/sand_vs_dens_FIA_PLS.png)
![](outputs/v1.6/awc_vs_dens_FIA_PLS.png)
![](outputs/v1.6/ksat_vs_dens_FIA_PLS.png)
![](outputs/v1.6/FIA_PLS_PC1_hexbinplots.png)





## Q4. What is the environmental space where the past was bimodal? How bimodal is the distribution? Where is this located within the N. American Midwest?

Ans. We can look at bins of precipitation to get an idea of where this bimodality coefficient is likely to be highest:

![](outputs/v1.6/precipitation_by_bins_100.png)

We can look at the bins of temperature to get an idea of where the BC is likely to be highest:
![](outputs/v1.6/tmean_by_bins.png)

We can also look at the density distribution with bins of the first Principal Component of the environmental data:

![](outputs/v1.6/PC1_by_bins.png)

We can also look at the density distribution with bins of the second Principal Component of the environmental data:

![](outputs/v1.6/PC2_by_bins.png)

####To fully answer this question of how bimodal the density is, we have to define a bimodality index. There are a few options for this:
  * Dip Test (null = unimodal distribution)
  * Bimodality Coefficient calculated from size, skewness, and kurtosis of the distributions, though there may be issues with both BC and the Dip test (Pfister et al. 2013)
  * BC > 0.556 suggests bimodality
  * BC is calculated with be calculated in the R package modes
  
Bimodality coefficient is calculated from a distribuiton of data as follows:

BC = $\frac{(skew^2 + 1)}{(kurtosis + 3)*\frac{(n-1)^2}{(n-2)*(n-3)}}$

Here we calculated the BC for a bin range of 25mm of precipitation, with non-overlapping and overlapping bins:

![](outputs/v1.6/PLS_FIA_precip_roll_nonroll_BC_bins.png)

We can also calculate BC of the Principal components (this is not as easily interpretable as binning by precipitation):
![](outputs/v1.6-5/PLS_FIA_PC1_PC2_BC_bins.png)


## Where is the bimodality located within the N. American Midwest?

Within the places that were bimodal in the past, and that are bimodal now, we want to know which were savannas and which were forests. We use a classificaiton scheme from Rheumtella et al. (), However there are alternate classificaitons that we could use, such as the scheme Chicago Wilderness has used. We could also make our own classification schemes using kmeans clustering.  

```{r, echo = FALSE, fig.cap = 'Table 1: Site table with highest correlation, year cored, and species present.'}

library(knitr)
library(pander)

df <- data.frame(Ecotype = c("Forest", "Savanna", "Prairie"),
                 Rheumtella = c("> 47 trees/ha", "0.5-47 trees/ha", "< 0.5 trees/ha"), ChicagoWilderness = c("> 100 trees/ha", "10-100 trees/ha", "< 10 trees/ha"))

pander(df, split.cells = 30)
```

### Ecotypes using the Rheumtella et al. classificaiton
![](outputs/v1.6-5/PLS_FIA_ecotype_map.png)

### Ecotypes using the Chicago Wilderness classification
![](outputs/v1.6-5/PLS_FIA_ecotype_cw_map.png)

### Where is the precipitation range where PLS and FIA densities are bimodal?
  * Precipitation climate space where BC > 5.5 
  * Using the BC values of non-overlapping bins of width = 25mm 
  * Bimodality occurs at both Low precipitation (525-600mm/year) and intermediate precipitation (800-1125 mm/year) in the past
  * Bimodality occurs less frequently on the modern landscape, but also at some low precipitations (575-625 mm/year) and some intemediate precipitations(975 - 1150 mm/year ) on the modern landscape. 

![](outputs/v1.6-5/PLS_FIA_precip_BC_map.png)

### Where is the temperature range where PLS and FIA densities are bimodal?
  * Places that are bimodal across temperature ranges (i.e. not linearly predicted by temperature) are mostly located in southern WI, and Indiana and Illinois.
  * This might suggest that some of the bimodality that occurs at intermediate preicipitation could be due to differences in temperature
  * The temperature range where tree density is bimodal is 7-10 degC.
  
![](outputs/v1.6-5/PLS_FIA_temp_1.5_deg_BC_map.png) 

### What is the 'climate space' in terms of Principal components where PLS and FIA density is bimodal?
  * Temperature and Precipitation dominate loadings of the PC1 
  * PC1 shows a similar region of bimodal savanna and forests as the temperature map
  * soil factors (sand, ksat) dominate the loadings of PC2
  * PC2 predicts stable savannas in regions with sandy soils, but the PC2 has bimodalities elsewhere in the midwest
  * When we map the places that are bimodal in both PC1 and PC2, we have an idea of the places that are bimodal after accounting for soils, temperature & precipitation

#### Principle Component 1 (temperature & precipitation)
![](outputs/v1.6-5/PLS_FIA_PC1_BC_map.png)

#### Principle Component 2 (soils)
![](outputs/v1.6-5/PLS_FIA_PC2_BC_map.png)

### Bimodality in both PC1 and PC2 space (accounting for temp., precip, & soils)
![](outputs/v1.6-5/PLS_FIA_PC1_PC2_BC_map.png)

####Interpretation: 
Within precipiation ranges that have bistablity, differences in temperature may account for differences in tree density. Other regions that are bimodal w.r.t. precipitaiton can be explained by soil factors, such as differences in soil sandiness (PC2). However, a small subset of areas are bimodal in both PC2 and PC1 space.   

## Summary:
  * PLS density is bimodal, while the modern density is not
  * We may be able to explain some of the distribution in tree density using envrionmental variables (above, and see GAM table)
  * However, none of the environmental variables here fully account for the the bimodality in the PLS data
  * We demonstrate that a large region of the midwest historically could have been either savanna or forest alternative states that are not predicted by precipiation.
  * More of the bimodality in PLS tree distribution is accounted for by tempearature and soils, but not all. 
  * The determininants on bimodality 
  * Athough historically, this region supported both savanna and forest states, the modern landscape has vitually no bimodal regions. This suggests that fire suppression, land use, and environmental changes that have occurred over the last ~ 150 years may have played a role in the decline of alternative savanna & forest states in the region. 

## Questions/things to work on:
  * Are there other variables that we should include?
  * Potentially including PDSI from LBDA
  * Figure predicting where the Midwest could be bimodal based on future climate
  * In terms of framing the paper, I need to discuss the regional environmental changes (fire suppresion, land use) in a way that makes it clear that these changes could have removed the endogenous vegetation feedbacks that are important for maintaining alt. stable states.
  





### References