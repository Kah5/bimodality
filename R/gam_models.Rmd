---
title: "Gam_model"
author: "Kelly Heilman"
date: "January 25, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Estimating the Mixture model
```{r, echo = FALSE}
library(bayesmix)

data(faithful)
hist(train$PLSdensity, breaks = 25)


# we want a mixture model with two components 
bayesmod <- BMMmodel(train$PLSdensity, k=2, priors=list(kind = "independence", parameter = "priorsUncertain", hierarchical = NULL)) # k=2 for two components

#assign controls for Jags
jcontrol <- JAGScontrol(variables = c("mu", "tau", "eta", "S"), burn.in = 1000, n.iter = 10000, seed = 10)

#run
z <- JAGSrun(train$PLSdensity, model = bayesmod, control = jcontrol, tmp = FALSE, cleanup = TRUE)

zSort <- Sort(z, by = "mu")

#plot mcmc and estimates of mu
plot(z, variables = "mu")

zSort

#plot posterior estimates
BMMposteriori(zSort)

# this estimates 2 modes with a mean of 11.0 and 191.5
# this 


################
#test mixture regression
library(mixtools)
data('CO2data')
attach(CO2data)
CO2reg <- regmixEM(CO2, GNP, lambda = c(1, 3) / 4,
 beta = matrix(c(8, -1, 1, 1), 2, 2), sigma = c(2, 1))

summary(CO2reg)
plot(CO2reg, density = TRUE, alpha = 0.01)

#try for training datasets
#CO2reg <- regmixEM(train$PLSdensity, train$pasttmean
 #                  , lambda = c(1, 3) / 4,
 #beta = matrix(c(10, -10, 15, 1), 2, 2), sigma = c(2, 1))

#summary(CO2reg)
#plot(CO2reg, density = TRUE, alpha = 0.01)

```


## Thinking about model design:

model density ~ f(environmental variables)
density ~ smooth(MAP) (in previous versions, climate was negative correlated with density??)
density ~ smooth(temp)
density ~ smooth(soil/sand)
density ~ smooth(precip. seasonality)
density ~ smooth(temp. seasonality)
density ~ smooth(MAP + temp)
density ~ smooth(MAP) + smooth(temp) + smooth(soil)

Generalized additive model: allows for non-linearities...

Alternatively, we could us the classification scheme of savanna and forest; this isn't as great, but it would allow us to use a logistic model:

Cross Validation Options:

* leave one out CV
* split into test and training 30/60 or 50/50?

Or just use information criterion AIC

```{r, echo = FALSE}

library(stargazer)
library(mgcv)
library(caTools)
library(ggplot2)

#dens.pr <- read.csv("data/midwest_pls_density_pr_alb1.6-5.csv") # just with grid cells that have both pls & FIA
dens.pr <- read.csv("data/midwest_pls_full_density_pr_alb1.6-5.csv") # full set of PLS data
hist(dens.pr$PLSdensity, breaks = 50)

# split into test and training datasets:
Y <- dens.pr$PLSdensity
msk <- sample.split( Y, SplitRatio = 1/2, group = NULL )
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]




PLS.gam1 <-gam(PLSdensity ~  s(MAP1910) +s(pasttmean) +s(sandpct) , data = train)
summary(PLS.gam1) #explains 0.004% deviance

preds <- predict(PLS.gam1, newdata = test)

plot(preds, test$PLSdensity)



test$preds <- preds
ggplot(test, aes(x = x, y = y, color = preds))+geom_point()+scale_color_gradient(low = "red", high="green")

plot(preds, test$PLSdensity, xlim = c(0,700), ylim=c(0,700))
test[is.na(test$preds),]$preds<- 0 

test$predeco <- 0
test[test$preds >=47,]$predeco <- "Forest"
test[test$preds <47,]$predeco <- "Savanna"
test[test$preds <0.5,]$predeco <- "prairie"

plot(test$MAP1910, preds)
plot(test$pasttmean, preds)
plot(test$sandpct, preds)
test$po <- preds - test$PLSdensity
ggplot(test, aes(x = x, y = y, color = po))+geom_point()+scale_color_gradient(low = "red", high="green")

ggplot(test, aes(x = MAP1910, y = pasttmean, color = preds))+geom_point()+scale_color_gradient(low = "red", high="green")

ggplot(test, aes(x = x, y = y, color = predeco))+geom_point()


ggplot(test, aes(x = PLSdensity, y = preds, color = predeco)) + geom_point()

plot(train$MAP1910, train$PLSdensity)


#lets try for logistic regression


# dummyvariables for logistic regression:
dens.pr$ecocode <- 0
dens.pr[dens.pr$ecotype %in% 'Forest', ]$ecocode <- 1
dens.pr<- dens.pr[!dens.pr$ecotype %in% 'prairie',]
#split training and testing
Y <- dens.pr$PLSdensity
msk <- sample.split( Y, SplitRatio = 1/2, group = NULL )
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]


plot(dens.pr$sandpct, dens.pr$ecotype)

logmod<- gam(ecocode ~ s(MAP1910) + s(MAP1910)^2, family = binomial, data = train)
summary(logmod)

ypred <- predict(logmod, newdata = test, type="response")
plot(test$MAP1910, ypred, pch = 16, xlab = "MAP", ylab = "Predicted")


lm.test <- glm(dens.pr$PLSdensity ~ dens.pr$MAP1910)



PLS.gam2 <- gam(PLSdensity ~ pasttmean , method = "ML", data = dens.pr)
#summary(PLS.gam2) #explains 15.8% deviance

PLS.gam3 <- gam(dens.pr$PLSdensity ~ dens.pr$pastdeltaP , method = "ML")
#summary(PLS.gam3) #explains 3.02% deviance

PLS.gam3 <- gam(dens.pr$PLSdensity ~ dens.pr$awc , method = "ML")
#summary(PLS.gam3) #explains 12.5% of deviance


PLS.gam4 <- gam(PLSdensity ~ pasttmean + pastdeltaP , method = "ML", data = dens.pr)
#summary(PLS.gam4) #explains 35% deviance

PLS.gam5 <- gam(dens.pr$PLSdensity ~ dens.pr$awc +dens.pr$sandpct , method = "ML")
#summary(PLS.gam5) #explains 14.9% of deviance

PLS.gam6 <- gam(dens.pr$PLSdensity ~ dens.pr$MAP1910 +dens.pr$pasttmean+ dens.pr$sandpct, method = "ML")
#summary(PLS.gam6) #explains 39% deviance

PLS.gam7 <- gam(dens.pr$PLSdensity ~ dens.pr$MAP1910 +dens.pr$pasttmean +dens.pr$awc , method = "ML")
#summary(PLS.gam7) #explains 41.3% of deviance

PLS.gam8 <- gam(dens.pr$PLSdensity ~ dens.pr$MAP1910  +dens.pr$pasttmean +dens.pr$sandpct + dens.pr$awc, method = "ML")
#summary(PLS.gam8) # explains 41% of deviance


```

## Results from Generalized additive models of PLS density with covariates:

```{r, echo = FALSE, results = 'asis'}

stargazer(PLS.gam1,PLS.gam2, PLS.gam3, PLS.gam4, PLS.gam5, PLS.gam6, PLS.gam7, PLS.gam8, type="html",
          title            = "GAM model results",dep.var.labels.include = FALSE,
          covariate.labels = c("Mean Annual Precipitation (mm)", "Mean Temperature (DegF)", "Mean Temperature (DegF)", "AWC", "Precipitaiton seasonality","% sand"),
          dep.var.caption  = "Pre-settlement tree density",
          dep.var.labels   = "Tree density (trees/ha)")


```

