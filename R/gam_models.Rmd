---
title: "Gam_model"
author: "Kelly Heilman"
date: "January 25, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Thinking about model design:

model density ~ f(environmental variables)
density ~ MAP (in previous versions, climate was negative correlated with density??)
density ~ temp
density ~ soil/sand
density ~ precip. seasonality
density ~ temp. seasonality
density ~ MAP + temp
density ~ MAP + temp + soil

Generalized additive model: allows for non-linearities...

Alternatively, we could us the classification scheme of savanna and forest, this isnt as great, but it would allow us to use a logistic model

Cross Validation Options:

* leave one out CV
* split into test and training 30/60 or 50/50?

Or just use information criterion AIC

```{r, echo = FALSE}

library(stargazer)
library(mgcv)
library(caTools)

dens.pr <- read.csv("data/midwest_pls_density_pr_alb1.6-5.csv") # just with grid cells that have both pls & FIA
dens.pr <- read.csv("data/midwest_pls_full_density_pr_alb1.6-5.csv") # full set of PLS data
hist(dens.pr$PLSdensity, breaks = 50)

# split into test and training datasets:
Y <- dens.pr$PLSdensity
msk <- sample.split( Y, SplitRatio = 1/2, group = NULL )
#table(Y,msk)

train <- dens.pr[msk,]
test <- dens.pr[!msk,]


PLS.gam1 <-gam(PLSdensity ~ MAP1910 + pasttmean + pastdeltaP, data = train)
summary(PLS.gam1) #explains 0.004% deviance

preds <- predict(PLS.gam1, newdata = test)

plot(preds, test$PLSdensity)

test$preds <- preds
ggplot(test, aes(x = x, y = y, color = preds))+geom_point()+scale_color_gradient(low = "red", high="green")

plot(preds, test$PLSdensity, xlim = c(0,700), ylim=c(0,700))
plot(test$MAP1910, preds)
test$po <- preds - test$PLSdensity
ggplot(test, aes(x = x, y = y, color = po))+geom_point()+scale_color_gradient(low = "red", high="green")

ggplot(test, aes(x = PLSdensity, y = preds)) + geom_point()

plot(train$MAP1910, train$PLSdensity)





lm.test <- glm(dens.pr$PLSdensity ~ dens.pr$MAP1910)

PLS.gam2 <- gam(PLSdensity ~ pasttmean , method = "ML", data = dens.pr)
#summary(PLS.gam2) #explains 15.8% deviance

PLS.gam3 <- gam(dens.pr$PLSdensity ~ dens.pr$pastdeltaP , method = "ML")
#summary(PLS.gam3) #explains 3.02% deviance

PLS.gam3 <- gam(dens.pr$PLSdensity ~ dens.pr$awc , method = "ML")
#summary(PLS.gam3) #explains 12.5% of deviance


PLS.gam4 <- gam(PLSdensity ~ pasttmean + pastdeltaP , method = "ML", data = dens.pr)
#summary(PLS.gam4) #explains 35% deviance

PLS.gam5 <- gam(dens.pr$PLSdensity ~ dens.pr$awc +dens.pr$sandpct , method = "ML")
#summary(PLS.gam5) #explains 14.9% of deviance

PLS.gam6 <- gam(dens.pr$PLSdensity ~ dens.pr$MAP1910 +dens.pr$pasttmean+ dens.pr$sandpct, method = "ML")
#summary(PLS.gam6) #explains 39% deviance

PLS.gam7 <- gam(dens.pr$PLSdensity ~ dens.pr$MAP1910 +dens.pr$pasttmean +dens.pr$awc , method = "ML")
#summary(PLS.gam7) #explains 41.3% of deviance

PLS.gam8 <- gam(dens.pr$PLSdensity ~ dens.pr$MAP1910  +dens.pr$pasttmean +dens.pr$sandpct + dens.pr$awc, method = "ML")
#summary(PLS.gam8) # explains 41% of deviance


```

## Results from Generalized additive models of PLS density with covariates:

```{r, echo = FALSE, results = 'asis'}

stargazer(PLS.gam1,PLS.gam2, PLS.gam3, PLS.gam4, PLS.gam5, PLS.gam6, PLS.gam7, PLS.gam8, type="html",
          title            = "GAM model results",dep.var.labels.include = FALSE,
          covariate.labels = c("Mean Annual Precipitation (mm)", "Mean Temperature (DegF)", "Mean Temperature (DegF)", "AWC", "Precipitaiton seasonality","% sand"),
          dep.var.caption  = "Pre-settlement tree density",
          dep.var.labels   = "Tree density (trees/ha)")


```

